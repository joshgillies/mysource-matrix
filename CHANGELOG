MYSOURCE MATRIX CHANGELOG

VERSION 3.22.7

Featured Changes
-----------------------------------

Reporting added to Incomplete Attachments System Integrity script
	A list of Incomplete Attachments found and/or deleted is shown at the end of this script.


Check Indexes System Integrity Script: Oracle Parallel Index Rebuild notification
	Additional checking has been added to this script to notify whether any database indexes have been built in parallel in Oracle environments.
As rebuilding in this manner can cause performance issues, further information is provided to rebuild these index entries if this state is detected.



Additional Changes and Bug Fixes
-----------------------------------

Core
Fixed Bug #3273: Unable to find lineage error on webpaths screen
Fixed Bug #3675: Tagging screen for Multiple Page Pages
Fixed Bug #3776: New Divs cant create
Fixed Bug #3860: htmlentities without character encoding
Fixed Bug #4002: data_path problems after upgrade
Fixed Bug #4023: No webpath set when cloning a MP3 asset
Fixed Bug #4024: Delete funtionality of import_asset_csv_to_matrix.php script doesn't deletes dependent assets 
Fixed Bug #4029: Form Question Select sometimes omit the keys
Fixed Bug #4030: Remote Content nested into Account Manager
Fixed Bug #4034: getParents() for a shadow asset returns non-significantly linked assets
Fixed Bug #4035: Thesaurus->getParents always returns an empty array
Fixed Bug #4038: Visual Aid in WYSIWYG toolbar does not turn off in IE
Fixed Bug #4039: Issue with sorting Asset Metadata group
Fixed Bug #4041: Custom Form emails a file that has been cleared
Fixed Bug #4048: Hierarchy metadata applies incorrectly if more than 1
Fixed Bug #4050: getParents() not returning expected result when min_height and/or max_height parameters supplied
Fixed Bug #4051: Customise Form: Client-Side Validation is always Case sensitive 
Fixed Bug #4052: Incorrect %asset_metadata_*% keyword causes segfault
Fixed Bug #4054: Video File Asset: Upload without audio gives errors
Fixed Bug #4055: Inbox produces a PHP Fatal Error
Fixed Bug #4057: Form validation rules are ignored when form is saved
Fixed Bug #4061: Cancelling Safe Edit on a Backend User breaks their password
Fixed Bug #4062: Function export in csv.inc does not close file stream 
Fixed Bug #4066: Metadata date field formated 'c' not displaying with keywords
Fixed Bug #4077: Squiz server + oracle will freeze on hipo jobs with warning messages

CMS
Fixed Bug #3937: Form Submission's keywords "question_name_qY" and "question_answer_qY" fail to work
Fixed Bug #4017: Submission logs doesnt show link to download uploaded file
Fixed Bug #4018: Download link On submission logs screen doesnt work
Fixed Bug #4028: Online poll asset vote button has same element id as form itself
Fixed Bug #4031: Youtube video embed inserts invalid HTML
Fixed Bug #4033: Form Action Save As XML throws an isset notice
Fixed Bug #4036: Custom form with no question will display errors when trying to download submissions
Fixed Bug #4043: Form Save XML Action Type doesn't escape the name properly
Fixed Bug #4045: Exporting Submission Logs produces a Database error

Data
Fixed Bug #4063: Asset status change fails after db query trigger executed
Fixed Bug #4065: Commit XML data source gives error "Fatal error: Argument 1 passed to Data_Source::setResultSet() must be an array..."

E-Commerce
Fixed Bug #4068: Form validation does not work completely on Delivery Method forms for E-Comm

Search
Fixed Bug #4047: Oracle search fails multiple word keys search with select/multiselect



VERSION 3.22.6

Complete changelog
-----------------------------------

Core
Fixed Bug #3807: Workflow email send to second reviewer contains wrong content and links
Fixed Bug #3826: WYSIWYG in Firefox JavaScript error
Fixed Bug #3918: PHP notices from invalid apparent keywords in metadata
Fixed Bug #3932: Keywords for Data Source Record Set asset don't get replaced when using a keyword modifier
Fixed Bug #3943: Trigger Name HTML Entities changing on Commit
Fixed Bug #3946: Metadata "Use default" checkbox does not disable value components
Fixed Bug #3947: _recache sends cacheable headers
Fixed Bug #3949: Error when cloning a design
Fixed Bug #3951: Workflow emails not sent out with users that have special characters in the name field
Fixed Bug #3952: Cannot unselect checkbox questions in multipage form
Fixed Bug #3953: Workflow escalation step email directs user to incorrect site
Fixed Bug #3955: Workflow notify on live feature doesn't work when role system is disabled
Fixed Bug #3957: Missing error message
Fixed Bug #3959: Lookups HIPO cascades force secure option
Fixed Bug #3976: Metadata Schemas screen: "Cascade to new" setting not using correct cascade box
Fixed Bug #3991: Run time error if SQ_CONF_WEB_PATH_SEPARATOR is empty
Fixed Bug #3992: Custom Form fails upon file upload
Fixed Bug #3994: User changed status from Archived to Under construction will throw error 
Fixed Bug #4006: Workflow will send Approval required and Asset Approved email at same time
Fixed Bug #4009: Access History - keyword_* print vars cause fatal error with purged assets

Bulkmail
Fixed Bug #3982: Possible typo in triggering error on Bulkmail subscribe page 

CMS
Fixed Bug #3973: Last url in white list only url being tunnelled in Remote Content
Fixed Bug #3975: Nested Asset Listing doesn't respect passed GET paramater for A-Z list
Fixed Bug #4000: Form submission logs show the wrong date
Fixed Bug #4007: File Upload Question Type does not paint correctly
Fixed Bug #4012: Remove Incomplete Submissions does not remove any attachments 

Data
Fixed Bug #3995: Race condition in hit count

Import Tools
Fixed Bug #3990: Asset name of "Word Import Tool Converter" can be changed

Search
Fixed Bug #3988: Issues with metadata matching in Global Search/Replace Tool



VERSION 3.22.5

Featured Changes
-----------------------------------

JS API: Asset Type Filter and Attributes
	Assets created by the "createAsset" action can now be restricted by one or more exact asset types. It is also possible to pass in attributes other than the asset name when creating assets. 

The attribute names and values are supplied to the JS API "createAsset" action in the following notation:
eg; (For a News Item)
    contact_name=Fred&contact_phone=0123

Will set the Contact Name to "Fred" and the Contact Phone to "0123"

The return of result codes via JSON can now be disabled to prevent end users seeing information such as asset IDs. This and the above modifications are controlled from the "Details" screen of the JS API asset.

These modifications have been graciously contributed by JS API author Nic Hubbard.


Requirements Checking script

	A requirements checking script, install/check_requirements.php, has been added to verify the program requirements of a Matrix installation against the server configuration. This script is executed from the Matrix system root directory as follows:

    php install/check_requirements.php /path/to/matrix

Required third-party applications, PHP extensions and PEAR packages will be notified, as well as suggested utilities which provide certain optional functionality within Matrix.


Additional Changes and Bug Fixes
-----------------------------------

Core
Fixed Bug #3890: Trigger action set metadata breaks trigger when asset number incorrectly specified
Fixed Bug #3901: Unable to preview files when using static content server
Fixed Bug #3904: HIPO does not work with UTF8 asset names
Fixed Bug #3905: Force secure option strips the url if the option is different from parent
Fixed Bug #3907: Cannot clone CSS Design files
Fixed Bug #3908: Create empty text file feature does not work due to permissions
Fixed Bug #3911: Cloning an asset with link value will get error
Fixed Bug #3913: Custom Form - Day of the week incorrect
Fixed Bug #3914: Hot key in WYSIWYG moves focus to document to
Fixed Bug #3915: Export Thesaurus Terms doesn't export Notes properly
Fixed Bug #3916: Export Files tool won't work with a slash in asset name
Fixed Bug #3917: Undefined index: never_delete
Fixed Bug #3922: .dot file asset served as text/plain  
Fixed Bug #3924: Moving assets - will not sit at bottom of a list
Fixed Bug #3926: WYSIWYG adds invalid markup
Fixed Bug #3938: backup script broken for local Oracle DB
Fixed Bug #3939: Settings Screen - Can't click "Now" button to set date

Bulkmail
Fixed Bug #3925: Asset listing dynamic root node does not work with Bulkmail job send

Calendar
Fixed Bug #3935: Use %edit_link% in each event page of calendar will get error

CMS
Fixed Bug #3823: Switching nested arbitrary paint layout

E-Commerce
Fixed Bug #3893: Order details not saved until Payment Gateway success code received

Search
Fixed Bug #3863: Search pages do not always XHTML Validate
Fixed Bug #3887: Global weights not overridden in some situations

Web Services
Fixed Bug #3929: Use of web serivices JS API asset service result in parse error



VERSION 3.22.4

Featured Changes
-----------------------------------

JS API Asset updates
	The JS API asset now supports a much larger range of actions, including asset creation, linking functions, locking, permissions and getting of parents / children. An asset can now be sent to the API using either asset ID or URL. The "General Info" function now includes an attribute for an asset's Web Path.


Search Manager Permission performance enhancements
	A database query which performs permission checks in Search Manager has been optimised for greater performance.


Day Labels for Calendar Page
	A new "Day Labels" screen has been added to Calendar Page assets to specify the names of each day of the week in shortened or even in other languages.
These Day Labels are reflected in the default Week and Month "Calendar" views and the first letter of each is also shown in the Year "Calendar" view.


Macron support in WYSIWYG Character Map
	Support for macron vowel characters - characters with bars above as used in languages such as Maori - have been added to the WYSIWYG Character Map component. 


IPB Package compatibility with IP Board 3.0.2
	Assets in the IPB Package (IPB Bridge etc.) have been assessed and now provide compatibility with IP Board 3.0.2.
The version number of IP Board must be changed from the Details screen of the IPB Bridge asset to make Matrix aware of the version in use. This is done via a drop-down list, from which 3.0.2 can be selected. 


Regenerate Trigger Tree IDs script
	A new script - scripts/regenerate_treeids_for_triggers.php - has been added to rebuild the Triggers table in response to an issue resolved as Bug 3864: Rebuilding Link Tree breaks triggers.

When running the existing recreate_link_tree.php script, a message will appear if running this new triggers script is required. As these scripts either modify or provide SQL to run manually on a Matrix system, it is highly recommended to back up the system beforehand. 


DPS Payment Gateway
	A new payment gateway for Direct Payment Solutions (DPS) is now available in the E-Commerce package. Payments are posted and processed via XML through the PxPost service provided by DPS.

General functionality available to existing Gateway assets is available within the DPS Payment Gateway.



Additional Changes and Bug Fixes
-----------------------------------

Core
Fixed Bug #3812: LDAP users cannot be unlinked from groups when safe trash enabled
Fixed Bug #3817: CSVs stored as File assets are not served from Matrix with correct Content Type headers
Fixed Bug #3820: remove_assets_of_type.php : Postgres 8.3 feature breaks script and call to wrong DAL function
Fixed Bug #3826: WYSIWYG in Firefox JavaScript error
Fixed Bug #3827: WYSIWYG bug, replace text tool fail to replace double spaces in selected text
Fixed Bug #3835: Notice links Lineage shown when clicking on binoculars icon
Fixed Bug #3843: WYSIWYG bug: Visual aid tool doesn't work properly in IE8
Fixed Bug #3846: Invalid XHTML produced by metadata select field on search form
Fixed Bug #3849: Script remove_assets_of_type.php leaves unwanted table entries
Fixed Bug #3856: Unable to create new Thesaurus Term asset in 3.22.3 
Fixed Bug #3864: Rebuilding Link Tree breaks triggers
Fixed Bug #3865: Design parse file not editable in IE 8
Fixed Bug #3866: Locks not deleted when an asset deleted
Fixed Bug #3877: Matrix will create and retain links in DB if asset fails to get created
Fixed Bug #3878: WYSIWYG Links (generated by Insert Link) traverse lines
Fixed Bug #3884: Search page category - unable to delete
Fixed Bug #3886: Extra links created on failed deletion attempts
Fixed Bug #3888: Database transactions cannot be managed across connections
Fixed Bug #3889: remove_internal_messages.php script does not delete messages / gives error

Calendar
Fixed Bug #3825: Prev and Next keywords should use getURL()

CMS
Fixed Bug #3870: Nesting an asset in Simple Edit Layout produces PHP error
Fixed Bug #3880: Assign by reference in cron_job_manage_incomplete_submissions.inc

Data
Fixed Bug #3816: Hit count listing - missing depth attributes

Google Maps
Fixed Bug #3844: Too many geocode request from google map asset causes page to stall

IPB
Fixed Bug #3829: IPB user authentication broken
Fixed Bug #3834: IPB bridge getAsset function not compatible with bridge interface
Fixed Bug #3836: Mysql db in IPB package doesn't work

Search
Fixed Bug #3813: Backend search with a search string containing a slash causes an error
Fixed Bug #3855: Search page %next_result_page_href% doesn't navigate to last result page



VERSION 3.22.3

Featured Changes
-----------------------------------

File Data optional when creating File, JS, CSS and Text File assets
	A blank file is created if no file data is supplied when creating a File, JS, CSS or Text File asset. Previously this would have resulted in an error message being displayed.


Menu Design Area: Include selected asset types
	Asset types to be included for display can now be specified in Menu Design Areas. This compliments the existing functionality to exclude particular asset types from being displayed here.


Update Sharepoint Record CRON Job
	A nightly Cron Job has been added to download and update Sharepoint documents as specified in a Data Source asset.


Metadata Section Description attribute
	A "Description" attribute has been added to the "Details" screen of Metadata Schema and Section assets. The specified description can either be included or excluded from the metadata tags generated. This is controlled from the Metadata Section and defaults to "No" (ie; not generated).

The description can also be modified from Simple Edit via the following new keywords, which take an Asset ID as a dynamic value (denoted by "xx"):
	- %metadata-F_section_xx_name%
	- %metadata-F_section_xx_description%
	- %metadata-F_section_xx_values%


Multiple Tag assignment via Set Tag Trigger Action
	The "Set Tag" Trigger Action now supports array-based selections (eg; those generated by checkbox submissions) via the Parameter Map. 


Parameter Map Option: Any Super Global
	This new Parameter Map option will select a value from any of the major "super-global" arrays. In order, it will check the Session variable sandbox, then POST variables, then GET variables, until it can find a value.


Set Thumbnail Action: New Dynamic Parameter
	The Set Thumbnail trigger action now allows you to override the asset used as the thumbnail image with a value set from a Parameter Map.


Style Drop-Down for Bodycopy DIVs
	In 3.22.2, a feature was added to the Design asset to restrict the styles shown in the WYSIWYG style drop-down. This feature has now been extended to Bodycopy DIV assets (using a separate list of styles), and improved.

Both lists of styles now use a key/value system; the "value" is used as an alias in the drop-down list. These are still managed from the Styles screen of the Design.

If these lists are empty, the WYSIWYG drop-down will be filled with styles auto-detected from the parse file, and the Bodycopy DIV class setting will be a text box only.


Update Lookups script: Set Root Nodes
	The scripts/system_update_lookups.php script now accepts a list of root nodes to restrict updating to. These are specified as one or more additional parameters after the system root, as follows:

	php scripts/system_update_lookups.php [SYSTEM_ROOT] 123 456 ...



Additional Changes and Bug Fixes
-----------------------------------

Core
Fixed Bug #3760: Structured Root Selector listing order problem
Fixed Bug #3766: "?SQ_ACTION=logout" can send cacheable headers
Fixed Bug #3770: Can not remove workflow schema for image asset with varieties
Fixed Bug #3771: Workflow cascade option give error
Fixed Bug #3773: Update lookups fail when asset has more than 1000 web paths
Fixed Bug #3784: Custom form - file upload
Fixed Bug #3795: Turning off caching for a customised type code does not turn off cacheable headers
Fixed Bug #3796: Paint layouts no removed from DB when URLs removed
Fixed Bug #3799: No preview shown when adding col or row in Wysiwyg Table Properties
Fixed Bug #3802: backup.sh v1.17.2.1 trying to write to the wrong directory
Fixed Bug #3803: Set metadata trigger not escaping "=" correctly
Fixed Bug #3805: Script system_update_lookups.php will faill if there is any assets in system with safe edit status
Fixed Bug #3810: Ecommerce Form Page cloning
Fixed Bug #3811: Submission logs (and other CSV) cannot be downloaded from the backend
Fixed Bug #3814: Ensure one upper case letter, if upper case letter is enabled in CAPTCHA
+ Increased randomness added to CAPTCHA string - no longer alternates between vowels and consonants

Bulkmail
Fixed Bug #3414: Bulkmail + Oracle = Lost connection
Fixed Bug #3783: Bulkmail progress exceeding 100 percent

Calendar
Fixed Bug #3788: "Last" prefix on day of month missing
Fixed Bug #3789: Upcoming events Showing events beyond horizon

CMS
Fixed Bug #3758: %root_nodes% keyword broken on simple edit layout
Fixed Bug #3774: Validated users don't get permissions from user group
Fixed Bug #3808: Asset listing gives error if sent list of assetid's that have a trailing comma

Data
Fixed Bug #3704: Apostrophe in XML Data Source output shows only remaining of the elements content

Search
Fixed Bug #3780: Search Page position -1 formatting not applied

Web Services
+ The JS API asset, introduced in the 3.22.2 release, can now be nested under the Web Services Folder



VERSION 3.22.2

Featured Changes
-----------------------------------

Asset Keywords of Nesting Asset as GET variable values in Nest Content Type
	Asset keywords for the nesting asset can now be passed as HTTP GET variables to the nested page in the Nest Content Type. The keywords of the surrounding page are passed in by using the %asset_*% keyword format.


Inverse Logic for Trigger Conditions
	Trigger Conditions now have an additional checkbox which when checked will evaluate the condition as having passed when the inverse logic of the condition specification is met. For example, an "Asset is of Type" Trigger Condition set to match on "Image" types would pass when the triggering asset is not an "Image" type if inverse logic was enabled.

Please note that as the inverse logic of any condition will likely be met in a large number of scenarios, so it is recommended to use this functionality carefully and sparingly for performance reasons.


Session Variable value assignment from Redirect Pages
	A new section, "Session Variables", has been added to the Details screen of the Redirect Page asset to provide dynamic assignment of session variable values. This functionality uses the Parameter Map to assign either a static value, which can also comprise Asset and Global Keywords, and values sourced from other GET, POST or SESSION variables.

As a result of this development, a "Set Value" option has been added to the Parameter Map to support the assignment of static values.


Option List attribute "No Arrows" option
	The up and down arrows displayed to transpose values in Option List attributes is now optional when this type is rendered from an XML definition of an asset.

In order to display an Option List attribute without arrows, please use the following XML structure:

           <option_list allow_reorder="no" /> 


Customisation of styles shown in WYSIWYG Style drop-down
	The WYSIWYG Style drop-down list displays a list of styles obtained from CSS files associated with the current Design. A new "Styles" screen is now available for Design assets and customisations which can be configured to determine which of these styles is to be shown in this list.


Delete Bulkmail Users by Root Node
	The "Delete Bulkmail Users" tool now allows Bulkmail Users to be deleted from underneath specified Root Nodes, rather than just system-wide.


Localisation of ampersand replacement in Web Paths
	Web Paths that contain the ampersand (&) character or its HTML entity (&amp;) were converted to "-and-" by default. The word "and" and the web path separator (-) are now obtained from a language localisation "web_path_ampersand_replacement" and the SQ_CONF_WEB_PATH_SEPARATOR value specified in the main.inc configuration file.

This allows greater flexibility in the format chosen for this replacement as it ensures consistency with the system web path separator and current translations for the system.

A further modification has been made to prevent multiple contiguous 'and' strings from being added (eg; as would happen for "http://example.com/site&&page"). These are now reduced to one instance (ie; site&&page -> site-and-page).


After Metadata Updated Trigger Event
	This new Trigger Event will fire just after metadata has been set and regenerated for the firing asset. This contrasts with the existing Metadata Updated event which is also fired after metadata has been set, but *before* regeneration. 


Asset Recached Trigger Event
	A Trigger Event is now fired when an asset is recached using the "_recache" suffix. This can be captured by Triggers and used for automation purposes.


Calendar Page date range limiting while browsing
	A lower and upper bound has been added to the "Details" screen of the Calendar Page asset to restrict navigation between time period views using the "Next" and "Previous" links.

This restriction is be disabled by default, but when enabled will be based on the current system date. Manually entered dates in the address bar outside the relevant range for the view will show no "Next" and "Previous" navigation.

Each view can be configured independently and asymmetrically. For example, the Month view can have no restriction while the Year view is restricted to between 2 years in the past to 4 years in the future.


Control of frontend error display via URL
	System Administrators can now append a query string variable 'SQ_SHOW_ERRORS' to view the frontend errors if they are hidden, as specified on the "System Configuration" screen.


Thesaurus Metadata Field Update Tool
	The "Details" screen of Thesaurus Term assets has a new option to update related Thesaurus Term metdadata fields in the system when the name of the term is changed.

An accompanying Matrix Tool, "Change Thesaurus Term", may also be used to affect the same set of changes either by root node or system-wide.


Set Session Variable Form Action
	This Form Action can be configured to set one or more PHP session variables upon form submission. The session variables used are user-defined and can be used in other areas of Matrix via the %globals_session_xx% Global Keyword.

The values that can be stored by this Form Action are obtained from the related Form Submission asset, such as the IP address used, the submission date and the responses given.


Form Posted Condition modification
	The "Form Posted" Condition, available in Design Areas and Paint Layouts, has been modified to evaluate to TRUE only when the form submission is triggered via a POST submission instead of only when the POST itself is empty.


JavaScript API to Matrix
	A new asset "JavaScript API" has been graciously contributed by Nic Hubbard to the Web Services package. Unlike the Web Services package itself, this new asset will be released on Monday under the GPL.

The JavaScript API asset returns JSON objects in response to general asset queries. Currently this asset supports the following function calls:

  - getGeneral    (asset information such as name and path)
  - getAttributes (asset attributes)
  - setAttribute
  - getMetadata   (returns all metadata from all assigned schemas)
  - setMetadata   (sets a single metadata field value)
  - trashAsset

Access to call these functions is controlled by an API Key value set on the "Details" screen of the JavaScript API asset. The function setApiKey() must be called in JavaScript before the first call to one of the above functions.

Each function can be independently enabled or disabled from the asset in order to limit the dynamic capabilities provided via JavaScript calls.


Support for editing and deleting existing assets from the CSV to Matrix Importer script
	Modifications have been made to the CSV to Matrix Importer script, "import_assets_to_csv.php" in the scripts directory, to enable editing and deleting existing assets which match a primary column in the source CSV file. Additional options are available which allow the primary column and a flag column to be specified on the command line. The flag column must contain either "A", "E", or "D" to indicate whether the record is to be (A)dded, (E)dited or (D)eleted.

Please note that deletion performed by this script is permanent and bypasses the trash. Any requests to Edit an asset that does not exist is turned into an Add request. Requests to Add assets that already exist are turned into Edit requests. Requests to Delete an asset that does not exist will be ignored and the script will continue.

A further "ignore" file can be provided with single column list of items to ignore when performing an "Edit" operation. For example, if user passwords are supplied in the CSV import file in order to create User assets, these can be ignored if supplied again in an "Edit" context. In this example it would ensure that the password is not set again from the import file.

As with the previous revision of this script, a CSV file is provided on STDOUT to monitor the assets affected. In this revision an additional column is given in this output to indicate the actual operation performed on the asset (eg; [primary identifier],[asset id],E).


Username availability upon Archiving User Assets
	When a Matrix User asset is set to "Archived", the held username is released for use by subseqent User assets. Upon changing the status back from "Archived", if the old username is taken by another user, a number is appended to the username to maintain the unique association (eg; fred => fred1), similar to the handling of Web Paths. 



Additional Changes and Bug Fixes
-----------------------------------

Core
Fixed Bug #3668: Error when previewing asset after design change
Fixed Bug #3698: Wysiwyg for %__custom_contents% keyword not working properly in simple edit layout.
Fixed Bug #3701: Error when Thesaurus Terms in Asset Map
Fixed Bug #3705: Custom form file uploading will not update existing uploaded file if the user doesn't have write permission
Fixed Bug #3707: Image editor crashes browser
Fixed Bug #3709: Replace text button in WYSIWYG removing href attributes
Fixed Bug #3712: BMP file not be able to be uploaded in custom form file upload if enforced MIME check is on
Fixed Bug #3713: Some video files and ms office files will not be able to be uplloaded in custom form if enforced mime check is on
Fixed Bug #3715: History screen of an asset will not display ldap user's editing history
Fixed Bug #3716: Global keyword in paint layout regexp condition doesn't evaluate to true
Fixed Bug #3718: Wrong name in "forcibly removed lock" email
Fixed Bug #3722: In Rollback mode, only root user can view assets
Fixed Bug #3724: Errors in cron_errors.log and system.log from workflow when on Oracle
Fixed Bug #3728: urls in customized workflow emails don't work
Fixed Bug #3732: Metadata textarea fields don't allow input - Safari 4
Fixed Bug #3734: Asset Listing Date Picker Fields are not XHTML valid
Fixed Bug #3735: Table Editor column widths unchangable
Fixed Bug #3736: Online Quiz Question Groups Simple Edit Layout details-F_name 
Fixed Bug #3738: Replace Text not working properly in Wysiwyg when text is selected
Fixed Bug #3740: asset_lnk variable in parse file not returning correct URL
Fixed Bug #3743: Paint layout javascript issue
Fixed Bug #3745: Replace url script does not replace paths on live public file assets
Fixed Bug #3746: Preview screen doesn't refreshes in table properties when value is changed
Fixed Bug #3752: Embed YouTube Fails
Fixed Bug #3755: Editing a table window doesn't close under Safari 4
+ Addition of TRIM file extensions TRF and TR5 to the supported MIME Types list, served with the "application/octet-stream" type
+ Exclude current asset from Listings, specified on the Details screen of Asset Listing, Search Page and What's New assets
+ Global Keywords for Asset Character Set and supported languages: %globals_asset_charset% and %globals_asset_languages%
+ New keyword %asset_web_path%, which returns the shortest Web Path assigned to the current asset

CMS
Fixed Bug #3689: Incomplete metadata report will give error message when parsing non unicode metadata field name
Fixed Bug #3692: Confirmation page not working for a single page custom form
+ Configurable CAPTCHA Error Message for Forms, specified on the Details screen of Form assets

Calendar
Fixed Bug #3751: Recurring event's keywords not working in event list asset
+ Calendar Event asset types may now be created and moved under Standard Page assets

Google Maps
Fixed Bug #3750: Google map hangs when http code 620 is received

Import Tools
Fixed Bug #3744: Unable to delete files from structured file import

Search
Fixed Bug #3737: Search: exclude field broken



VERSION 3.22.1

Featured Changes
-----------------------------------

New Default System Encoding for new installations
	New installations beginning from 3.22.1 have a default System Encoding of "utf-8" instead of "iso-8859-1" which was the case in previous releases. The System Encoding can be configured from the main.inc file during installation.


Send Email Trigger Action: Support for sending assets
	The frontend contents of an asset, along with a selected design or Paint Layout, can now be sent via email from this Trigger Action instead of the supplied bodycopy.


Text Direction option for Bodycopy DIV and Table elements
	An option has been added to the "DIV Properties" and "Table Properties" bodycopy icons (at table, row and cell level) to control the text direction HTML attribute for these elements. This feature provides support for both left-to-right and right-to-left languages on the same page. 


MIME Type and Virus Check Rule modifications for File Upload Form Questions
	A new File Question rule "Uploaded File Virus Check" has been added to scan the uploaded file via the ClamAV third-party utility as configured in "External Tools Configuration". This rule will prevent the file from being uploaded to the form should a virus be detected by the scanner. Custom text may be supplied to indicate the progress of virus scanning and to report scanning failure to the page.

A MIME Type check option has also been added to the "Uploaded File Type" question rule to ensure that the file data supplied matches that expected by the file extension.


Language Character Mapping for Web Paths
	A new option, "Use Language Character Map", has been added to System Configuration to provide character conversion for Web Paths for languages other than English. A set of Polish characters and closest English equivalents has been included and is installed by running step_03. This generates a new configuration file named lang_char_map.inc.

When enabled, the "Use Language Character Map" option will perform a character conversion for the current System Country (as set in System Configuration) which will affect the Web Paths of newly-created assets.


Access History persistence across sessions and Asset Keyword extraction
	The Access History Design Area can now store asset visits by a user in the database for persistence across sessions. This is done by configuring a new attribute "store_permanent" as follows.

	<MySource_AREA id_name="back_to_pages" design_area="access_history">
		...
		<MySource_SET name="store_permanent" value="true" />
		...
	</MySource_AREA>

Furthermore, all asset-level keywords can now be printed within the <MySource_AREA>. For example, the following structure would be used to print the Email Address of User assets:

	<MySource_PRINT var="keyword_asset_attribute_email" /> 


Additional Changes and Bug Fixes
-----------------------------------
Core
Fixed Bug #3629: Turning off Require Secure Login doesn't turn it off
Fixed Bug #3635: 2 CCS File assets in the list on asset is of type trigger condition
Fixed Bug #3643: Thesaurus Term with trailing space doesn't display in Metadata selection interface
Fixed Bug #3661: Custom form rule (check file type) can be skipped
Fixed Bug #3662: File virus check in creating a file will get errors if the file has a path which contains space
Fixed Bug #3663: Selecting asset id for purge trash root node not working
Fixed Bug #3664: backup.sh script fails under Solaris 10
Fixed Bug #3665: session_cleanup.sh script fails under Solaris 10
Fixed Bug #3667: In wysiwyg upload image popup, incorrect error message for uploading a virus infected file
Fixed Bug #3669: Set Future Lineage Trigger issue
Fixed Bug #3673: backup.sh creates schema-only db backup
Fixed Bug #3674: Keywords in the email sent by page_password_reset not replaced in emails
Fixed Bug #3683: External tool config virus check path can not be set if HTML tidy is not turned on
Fixed Bug #3685: File type check question rule in custom file will incorrectly check file type for second file upload
Fixed Bug #3686: Antivirus external tool doesn't even report virus on a properly setup Clam AV
Fixed Bug #3687: File assets fails to reacquire public URL after return from safe edit successfully
Fixed Bug #3691: %workflow_user% keyword not replaced in workflow screen

Bulkmail
Fixed Bug #3660: Bulkmail user linked under unsubscribed users when already subscribed

CMS
Fixed Bug #3619: Reset button on custom form does not work
Fixed Bug #3648: sq-form-field XHTML validation error
Fixed Bug #3656: Link Manager page doesn't recursively update lookups
Fixed Bug #3659: 'Multiple Page' cloning loses 'Multiple Page Page' web paths
Fixed Bug #3675: Tagging screen for Multiple Page Pages
Fixed Bug #3693: Account Manager Page Errors
Fixed Bug #3699: Save XML form action: where multiple optional file uploads, asset ID incorrect
Fixed Bug #3700: Save XML form action: File Upload's file content dump fails when filename is not webpath safe

Calendar
Fixed Bug #3639: A no results bodycopy of a calendar page doesn't display on a page when there is no events to list

Search
Fixed Bug #3679: Asset ID of newly created asset is not indexed

Web Services
Fixed Bug #3650: Web paths screen of SOAP API Asset Service throws fatal PHP error



VERSION 3.22.0

Featured Changes
-----------------------------------

Default Memory Limit and Roles Settings changed for new installations
	New installations beginning from 3.22.0 now have an increased memory limit default of 64Mb for Cron and Web processes. This will not modify any stored values for systems during upgrades - this is just for fresh installations.

The Roles system is also disabled by default for increased performance. This can be enabled from System Configuration in the backend to provide Roles functionality.


Image-based Keyword Replacement for User Email Address
	A new keyword added to User asset types, %asset_attribute_email_image%, can be used to display the email address of users as an image.
The font, colour and font size used for these images is configured under the "User Preferences" section of the "Global Preferences" screen (under System Configuration). User-specified fonts can be installed in "core/lib/fonts" which will then be available for selection.


User-defined Matrix Log Rotation time
	The rotation of Matrix log files, as performed by the Cron Manager, can now be configured to occur at a predetermined time. The Log Rotation time is configured from the "Options" screen of Cron Manager, the default setting of which is 1:00am. 


Listing Engine: Dynamic number of results per page
	Support for Matrix keywords has been added to the "Assets Per Page" option in Listing Engine-based assets such as Asset Listing and Search Page. This allows for control of the number of assets listed per page from other assets or from HTTP GET variables, for instance.


Remove Web Paths Trigger Action
	This new Trigger Action will remove a single Web Path from a specified asset when executed. Global and asset-level keywords may be used as the Web Path specified in the Trigger Action.

Two options are available to control Web Path operations - both of which are disabled by default:
  - Delete all Web Paths (for the specified asset)
  - Update lookups for children


"Update Child Lookups" option added to Add Web Paths Trigger Action
	In order to unify the functionality of Add and Remove Web Paths Trigger Actions, an "Update lookups for children" option, as mentioned above, has been added to the Add Web Paths Trigger Action. 


Video File asset
	A new Video File asset, graciously contributed by Nic Hubbard, has been added to the Matrix core. Like the MP3 File asset, this asset uses the getID3 third-party application.

The supported video extensions are:
  - mov
  - avi
  - wmv
  - asf
  - flv
  - mp4
  - m4v
  - mpg
  - mpeg

Video metadata is extracted by getID3 upon upload and these can be overridden and extracted again from the 'Details' screen.

The Bulk File Import Tool has also been amended to automatically create Video File assets when uploading files manually or from the server which match any of the supported file extensions.


SSL Accelerator Support
	Matrix can now determine whether it is behind an SSL accelerator proxy, based on the origin IP address (whether they are being forwarded through the router), header matching (exact match on header name and value), or both. This is needed because SSL accelerators provide a standard HTTP connection with Matrix, and Matrix needs to ensure that it still sends HTTPS links regardless.

SSL accelerator support can be configured through the "Proxy Configuration" screen of System Configuration. A "Force Insecure (HTTP)" option has been added to the SSL options on the asset "Settings" screen in order to instruct Matrix to provide only HTTP links or nothing for a certain asset.


Additional Changes and Bug Fixes
-----------------------------------
Core
Fixed Bug #3566: Fail to create cron job with set future status trigger
Fixed Bug #3582: Unable to select asset to remap to when deleting asset using linking page
Fixed Bug #3592: Email messages have an extra / in the asset URL
Fixed Bug #3597: "Simple edit user" cannot preview image in the "Insert Image" screen in the WYSIWYG
Fixed Bug #3599: Refresh Cache screen won't refresh all assets
Fixed Bug #3601: replace_url.php doesn't replace __data URLs when host name of new URL is different
Fixed Bug #3602: Site Map excludes assets with Public Read when viewed as a Backend User 
Fixed Bug #3603: Workflow schema with no steps result in fatal error
Fixed Bug #3625: When any of the File assets are cloned, it doesnt have webpath
Fixed Bug #3637: Run Tidy Script not backported to binary Tidy
Fixed Bug #3641: Tidy not enabled gives a status of pass 
+ Future Permissions Section relocated to bottom of the asset Permissions screen

Bulkmail
Fixed Bug #3540: Bulkmail cron job does not send bulkmails
Fixed Bug #3593: Bulkmail Job cannot be scheduled for large recipient groups

CMS
Fixed Bug #3452: Asset Statuses to List field for listing engine will lose value when changing status
Fixed Bug #3605: Nestings with paint layout set not working in simple edit
Fixed Bug #3609: Cannot unselect asset status from Asset Statuses to List in Asset lisiting and Search page
Fixed Bug #3610: Save XML does not work when using weird characters 
Fixed Bug #3616: Form sections do not copy correctly between sections
Fixed Bug #3620: Text wrong on the Form Contents screen of form contents asset
Fixed Bug #3630: form_summary keyword does not work on confirmation screen
Fixed Bug #3636: Adding multi level sections on a form causes PHP errors
Fixed Bug #3642: Form Action Save XML doesn't handle all cases of &'s

E-Commerce
Fixed Bug #3626: Ecommerce form permission problem for placing first order

Search
Fixed Bug #3595: WYSIWYG metadata default values not indexed
Fixed Bug #3596: Restricted metadata type default values indexed by search



VERSION 3.22.0 RC1

Featured Changes
-----------------------------------

Prevent Remaps from being deleted
	A new column has been added to remap entries in Remap Manager to lock entries to prevent accidental deletion. Once locked, an entry cannot be deleted (via the "Delete" checkbox) until that entry is unlocked.


Workflow emails suppressed for dependent assets if not linked in multiple locations
	Workflow emails (eg; notification, approval etc.) are only sent for dependent assets (eg; Bodycopy DIVs under Standard Pages) when these assets are linked in multiple locations.


Customised Caching by specific Root Node and/or Asset Type
	This new feature allows caching to be configured for nominated parts of the system. Two new screens have been added to Cache Manager - "Root Node Specific" and "Type Code Specific" - the latter which replaces the "Cache Expiry" screen.

Cache settings can be configured to propagate to child assets when specifying a root node to customised on the "Root Node Specific" screen.

Root Node and Type-Code Specific settings operate independently of the "Caching Status" as set on the "Details" screen of Cache Manager. "Type Code Specific" configuration options will take precedence over "Root Node Specific" configuration options where applicable.


"Add Web Path" Trigger Action: Lowercase webpath option
	A new option has been added to the "Add Web Path" Trigger Action to transform the supplied web path to lowercase before creating the web path.


Recache Option operation dependent on presence / absence of trailing slash
	The operation of the "_recache" suffix has been modified to re-cache only content with or without a trailing slash. For example, the URL http://example.com/page/_recache in the browser will re-cache the URL http://example.com/page (as the typed URL does not contain a trailing slash). The URL http://example.com/page/ (with trailing slash) will not be re-cached in this instance 


New Global Keywords for Random Number Generation
	Two new Global Keywords, %globals_random% and %globals_random_MIN_MAX% have been added to allow generated random numbers to be used in content. The "MIN" and "MAX" in the %globals_random_MIN_MAX% keyword refer to whole numbers. For example to generate a standard dice roll, the appropriate keyword would be %globals_random_1_6%


Listing Engine: Asset Contents Paint Layout keyword modification
	The %asset_contents_paint_[PAINT LAYOUT NAME]% keyword which paints the listed asset using the specified Paint Layout (functionality introduced in MySource Matrix 3.18.8) - has been expanded to allow the asset ID of a Paint Layout to be used instead of its name. 


Set Cookie Trigger Action
	A new Trigger Action has been added to allow a cookie to be set by name. Further attributes to restrict the cookie by domain, path and duration are available in this action.

The cookie "value" can be specified from the Parameter Map (ie; set from the value of a GET variable or Asset Keyword etc.)


SOAP API: Simple Restricted Types in WSDL
	Simple restricted types can now be added and passed in WSDL. Enumerations and restricted input value by pattern elements are supported. These data types can be nillable (empty without causing validation errors) and allow passing of multiple complex elements. Instructions on how to build or use a SOAP API for Matrix is provided in the "api_example.txt" file under the "api" directory.


Set Files to "Unrestricted" Command-Line Script
	A new command-line script "set_files_unrestricted.php" has been added to the "scripts" directory to allow the URL scheme of File-based assets to be set to "unrestricted" in a batch process.

This script requires the Root User password and takes the Matrix Root Directory and a Root Node asset ID from which to process the assets as parameters.


FLV File asset
	Similar to the MP3 File asset, the FLV File asset provides storage for a media file and automatic metadata extraction by the getID3() third-party tool, as configured from the "External Tools Configuration" screen in System Configuration.

Metadata is stored as FLV File asset attributes and can be manually overridden at any time. Extracting the metadata again from the "Details" screen will overwrite any previous manual changes made to this data.


System Backup Script shell modification
	The Matrix system backup script, "backup.sh" in the "scripts" directory now uses the /bin/sh shell instead of /bin/bash for increased portability.


Remove Permission Types via Future Permission setting and Trigger Action
	The Set Future Permission functionality, which allows permissions to be "Applied" or "Denied", now has the functionality to delete permission associations either from the associated Trigger Action or the asset "Permissions" screen.

In order to remove a permission from the "Permissions" screen, select "Remove" from the "Add / Remove" drop-down list in the "Future Permissions" section, then select the relevant appropriate "Apply" or "Deny" rule and target asset to affect.


E-Commerce: PayPal Payment Gateway
	Payments via PayPal are now supported in the E-Commerce package through the "Buy Now" one-click infrastructure. A simple PayPal-based storefront can be established through the configuration of the following asset types:

	* PayPal Configuration
	This asset stores information regarding encryption of PayPal transactions. The PPCrypto.php library file supplied by PayPal must be installed on the system and referenced from this asset in order to configure the PayPal Payment Gateway.

	* PayPal Business Account
	PayPal Account information for the storefront is stored in this asset, which includes public and private certificates to encrypt transactions between Matrix and PayPal. PayPal Business Accounts may be set in "Sandbox" mode for testing purposes and then to "Live" via a single attribute switch.

	* PayPal Payment Button
	This asset provides a "Buy Now" PayPal Button for a product. Product details such as item name, price, currency, the associated PayPal Configuration and Business Account is configured from this asset. Custom variables can be configured within the Payment Button which are posted back to Matrix from successful transactions.

	* PayPal IPN Receiver
	Successful Instant Payment Notifications are posted back to this asset. The IPN Receiver is configured to post back to an asset of choice, which may be determined by one of the variables posted back from PayPal (ie; carried through the transaction) or a fixed asset. The notified asset generates a "PayPal IPN Received" Trigger Event.

	* "PayPal IPN Received" Trigger Event
	This Trigger Event is used in the "Condition" section of a Trigger to perform operations upon successful payment. This can include granting permissions to the "purchased" asset for a subscription-based system or sending an email to the user.


Matrix SOAP Server
	A SOAP Server has been added to the Web Services package to enable core-level Matrix functions to be executed and queried by clients over the Simple Object Access Protocol.

The SOAP Server comes with a handful of APIs, each which performs a distinct set of Matrix functionality. These APIs are as follows:
	* Asset Service
	* Designs and Lookups Service
	* File Service
	* Link Service
	* Metadata Service
	* Permissions and Roles Service
	* Search Service
	* Workflow Service

Each API is an asset which is selected from the Asset Map and linked under a SOAP Server asset, which in turn is linked under the Web Services Folder.

The availability of APIs and their associated functions is configurable for each SOAP Server instance. For example a SOAP Server instance may be set up to allow retrieval of asset information via the Asset Service, but not creation of new assets. Each API and required function must be explicitly enabled before they are available for use.


Additional Changes and Bug Fixes
-----------------------------------

Web Services
+ SOAP Server error handling - an error handler has been added to log any SOAP Server errors to the Matrix Error Log

/**
* +--------------------------------------------------------------------+
* | MySource Matrix - Instructional Document                           |
* +--------------------------------------------------------------------+
*
* $Id: install.txt,v 1.5 2004/02/19 10:13:46 brobertson Exp $
* $Name: not supported by cvs2svn $
*/

Installation of Matrix
======================
Web server requires PHP 4.3.3 or higher and Apache 1.3.27 or higher.

You can choose to use either MySQL 3.23.58 or higher, MySQL 4.0.15 or higher, or PostgreSQL 7.3.4 or higher.

Installation currently requires a CLI (command line interface) version of PHP.

The HIPO service allows Matrix to pass off tasks to the Squiz Server instead of having to constantly refresh the editing interfaces. The service will also support multiple systems running on the same server. If you want to use this service, the PHP CLI and PHP apache module or version need compiling with specific options.

Skip this part if you are not going to use the HIPO service - the only requirements for PHP are that your database of choice is supported.

PHP - CLI Version
=================
Needs both --enable-pcntl and --enable-sockets support compiled in, and your database choice supported.

Note: According to http://www.php.net/manual/en/ref.pcntl.php - "Process Control should not be enabled within a webserver environment and unexpected results may happen if any Process Control functions are used within a webserver environment." - so --enable-pcntl must only be enabled for the CLI version.

Known good configure script:

'./configure' \
'--with-config-file-path=/etc' \
'--enable-inline-optimization' \
'--with-xml' \
'--with-gd' \
'--with-jpeg-dir=/usr' \
'--enable-exif' \
'--with-bz2=/usr' \
'--enable-bcmath' \
'--with-openssl' \
'--with-zlib=/usr' \
'--enable-wddx' \
'--enable-ftp' \
'--disable-cgi' \
'--enable-pcntl' \
'--enable-memory-limit' \
'--with-curl=/usr' \
'--with-gettext' \
'--enable-sockets' \
'--with-pspell=shared,/usr' \
'--with-mysql=shared,/usr' \
'--enable-gd-native-ttf' \
'--with-freetype-dir=/usr' \
'--with-pgsql=shared' \
'--enable-mbstring=all' \
'--with-pear'


PHP - Web Version
=================
Needs --enable-sockets support and your database of choice. If you wish to use the Spell Checker, you will need to install PSpell and compile support in '--with-pspell'

Known good configure script:

'./configure' \
'--with-apxs=/usr/local/apache/bin/apxs' \
'--with-config-file-path=/etc' \
'--enable-inline-optimization' \
'--with-gd' \
'--with-xml' \
'--with-jpeg-dir=/usr' \
'--enable-exif' \
'--with-bz2=/usr' \
'--enable-bcmath' \
'--with-openssl' \
'--with-zlib=/usr' \
'--enable-wddx' \
'--enable-ftp' \
'--disable-cgi' \
'--enable-memory-limit' \
'--with-curl=/usr' \
'--with-gettext' \
'--with-pspell=shared,/usr' \
'--with-mysql=shared,/usr' \
'--enable-gd-native-ttf' \
'--with-freetype-dir=/usr' \
'--with-pgsql=shared' \
'--enable-mbstring=all' \
'--with-snmp=shared,/usr' \
'--enable-sockets' \
'--disable-cli'


Now the requirements are out of the way, we can get back into installing Matrix.

You will need to create the database manually for Matrix - and grant the necessary access.

After getting Matrix onto the server, edit the install/step_01.php file and change the SQ_CONF_DB_DSN lines.

If you're using MySQL, the format is
define('SQ_CONF_DB_DSN', 'mysql://user@hostname/databasename');

If you're using PostgreSQL, the format is

define('SQ_CONF_DB_DSN', 'pgsql://user@hostname/databasename');

Note: For PostgreSQL, if the hostname is really the local server through a socket (rather than TCP/IP) the hostname becomes 'unix+localhost'.

If you're using the HIPO service, it is REQUIRED that you have two database users to connect to the same database for transaction support.
The 2nd connection is defined in the same way except it is called SQ_CONF_DB2_DSN. Passwords can be the same, the database name must be so.

If you are not using the HIPO service then define SQ_CONF_DB2_DSN as exactly the same as SQ_CONF_DB_DSN


Still in that file, if you want to enable RollBack support change

define('SQ_CONF_ROLLBACK_ENABLED', '0');

to 

define('SQ_CONF_ROLLBACK_ENABLED', '1');

This is not enabled by default because of the huge amount of data that will get stored over time.

If you have the search package installed, it is recommended to change

define('SQ_CONF_INDEXING_ENABLED', '0');

to

define('SQ_CONF_INDEXING_ENABLED', '1');

This will mean any updates to content will also get checked for search keywords to keep search information up to date. Leaving this off and turning it on later is not a problem, you can manually re-index Matrix to fill search information.

You will also need to change the SQ_CONF_DEFAULT_EMAIL and SQ_CONF_TECH_EMAIL addresses.

The SQ_CONF_TECH_EMAIL address is where any sort of errors get sent - so the technical person can address whatever problem has arisen.

Now we've got everything set up, it's a simple case of changing to the matrix directory and running

'php install/step_01.php .' -- this sets up data paths and configs.
'php install/step_02.php .' -- this creates database tables, sets up rollback tables and so on.
'php install/step_03.php .' -- this installs (and updates) the asset types and creates the base assets 


Lastly, you will need to set up 4 aliases in the Apache configuration. If you are running Matrix within a section of a site, you can set up your aliases as such

Alias "/section/__data"       "/path/to/matrix/data/public"
Alias "/section/__lib"        "/path/to/matrix/core/lib"
Alias "/section/__fudge"      "/path/to/matrix/fudge"
Alias "/section"              "/path/to/matrix/core/web/index.php"

If you have Matrix as the main site in your system, it is slightly different:

Alias "/__data"       "/path/to/matrix/data/public"
Alias "/__lib"        "/path/to/matrix/core/lib"
Alias "/__fudge"      "/path/to/matrix/fudge"
Alias "/"             "/path/to/matrix/core/web/index.php/"

Note: the last line requires the trailing slash on the end of index.php - otherwise Matrix will not work properly. This isn't required for a subsystem, but for the main system it is a necessity.

If you are going to be using the HIPO service on the Squiz Server, then edit [NEW SYSTEM ROOT]/data/private/conf/squiz_server.inc setting the details of the server and edit [NEW SYSTEM ROOT]/data/private/conf/hipo.inc changing : 

define('SQ_HIPO_USE_SERVER', '0');

to 

define('SQ_HIPO_USE_SERVER', '1');

Lastly, to enable the Matrix Cron Manager, a system crontab entry must be made.

0,15,30,45 * * * * /path/to/cli/php /path/to/matrix/core/cron/run.php

This means the cron entries will get actioned every 15 minutes - you can change this to every 5 minutes (add all intervals of 5 except for 60) or 10 minutes but more regularly than that is inadvisable.

Once you have your system up and running then one of the first things that you need to do is go to the Cron Manager and edit it's "Options" screen and set the "Epoch" and "Refresh Time" values


Restart apache, and everything should be right to go.

Visit http://yourdomain.com/_edit/ and log in.

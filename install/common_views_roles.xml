<?xml version='1.0' encoding='UTF-8' ?>
<!--
/**
* +- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
* | This MySource Matrix CMS file is Copyright (c) Squiz Pty Ltd       |
* | ACN 084 670 600                                                    |
* +- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
* | IMPORTANT: Your use of this Software is subject to the terms of    |
* | the Licence provided in the file licence.txt. If you cannot find   |
* | this file please contact Squiz (www.squiz.net) so we may provide   |
* | you a copy.                                                        |
* +- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
*
* $Id: common_views_roles.xml,v 1.1.2.1 2008/11/07 00:00:20 mbrydon Exp $
*
*/
-->
<sql>
	<sql_element display_name="sq_vw_ast_role View">
		<![CDATA[
			CREATE OR REPLACE VIEW sq_vw_ast_role AS
				(SELECT
					r.assetid, r.roleid, l.minorid as userid
				FROM
					sq_vw_ast_lnk_minor l INNER JOIN sq_ast_role r ON l.majorid = r.roleid
				WHERE
					r.userid = '0')
			UNION
				(SELECT
					assetid, roleid, userid
				FROM
					sq_ast_role
				WHERE
					userid <> '0')
		]]>
	</sql_element>
	<sql_element display_name="sq_vw_ast_perm View">
		<![CDATA[
			CREATE OR REPLACE VIEW sq_vw_ast_perm AS
				SELECT
					case when r.assetid is null then p.assetid else r.assetid end as assetid,
					case when r.userid is null then p.userid else r.userid end as userid,
					p.permission,
					p.granted,
					p.cascades 
				FROM
					sq_ast_perm p LEFT JOIN sq_vw_ast_role r on (r.roleid=p.userid AND r.assetid=p.assetid)

		]]>
	</sql_element>
	<sql_element display_name="sq_vw_ast_role Rollback View">
		<![CDATA[
			CREATE OR REPLACE VIEW sq_rb_vw_ast_role AS
				(SELECT
					r.sq_eff_from, r.sq_eff_to,
					r.assetid, r.roleid, l.minorid as userid
				FROM
					sq_rb_vw_ast_lnk_minor l INNER JOIN sq_rb_ast_role r ON l.majorid = r.roleid
				WHERE
					r.userid = '0')
			UNION
				(SELECT
					sq_eff_from, sq_eff_to,
					assetid, roleid, userid
				FROM
					sq_rb_ast_role
				WHERE
					userid <> '0')
		]]>
	</sql_element>
	<sql_element display_name="sq_vw_ast_perm Rollback View">
		<![CDATA[
			CREATE OR REPLACE VIEW sq_rb_vw_ast_perm AS
			SELECT
				CASE WHEN r.sq_eff_from IS NULL THEN p.sq_eff_from ELSE r.sq_eff_from END AS sq_eff_from,
				CASE WHEN r.sq_eff_to IS NULL THEN p.sq_eff_to ELSE r.sq_eff_to END AS sq_eff_to,
				CASE WHEN r.assetid IS NULL THEN p.assetid ELSE r.assetid END AS assetid,
				CASE WHEN r.userid IS NULL THEN p.userid ELSE r.userid END AS userid,
				p.permission,
				p.granted,
				p.cascades
			FROM
				sq_rb_vw_ast_role r
				LEFT JOIN sq_rb_ast_perm p
				ON (r.roleid = p.userid AND r.assetid = p.assetid)
		]]>
	</sql_element>
	<sql_element display_name="sq_vw_ast_role Disabled View">
		<![CDATA[
			CREATE OR REPLACE VIEW sq_vw_ast_role AS
			SELECT
				assetid, roleid, userid
			FROM sq_ast_role
				WHERE userid <> '0'
		]]>
	</sql_element>
	<sql_element display_name="sq_vw_ast_perm Disabled View">
		<![CDATA[
			CREATE OR REPLACE VIEW sq_vw_ast_perm AS
			SELECT
				p.assetid, p.userid, p.permission, p.granted
			FROM
				sq_ast_perm p
		]]>
	</sql_element>
</sql>

<?php
/**
* +--------------------------------------------------------------------+
* | Squiz.net Open Source Licence                                      |
* +--------------------------------------------------------------------+
* | Copyright (c), 2003 Squiz Pty Ltd (ABN 77 084 670 600).            |
* +--------------------------------------------------------------------+
* | This source file may be used subject to, and only in accordance    |
* | with, the Squiz Open Source Licence Agreement found at             |
* | http://www.squiz.net/licence.                                      |
* | Make sure you have read and accept the terms of that licence,      |
* | including its limitations of liability and disclaimers, before     |
* | using this software in any way. Your use of this software is       |
* | deemed to constitute agreement to be bound by that licence. If you |
* | modify, adapt or enhance this software, you agree to assign your   |
* | intellectual property rights in the modification, adaptation and   |
* | enhancement to Squiz Pty Ltd for use and distribution under that   |
* | licence.                                                           |
* +--------------------------------------------------------------------+
*
* $Id: cron_manager_edit_fns.inc,v 1.37.2.1 2006/08/15 06:27:20 arailean Exp $
*
*/


require_once SQ_INCLUDE_PATH.'/asset_edit/asset_edit_fns.inc';

/**
* Cron_Manager_Edit_Fns
*
* Purpose
*
*
* @author  Blair Robertson <blair@squiz.net>
* @version $Revision: 1.37.2.1 $
* @package MySource_Matrix_Packages
* @subpackage __core__
*/
class Cron_Manager_Edit_Fns extends Asset_Edit_Fns
{


	/**
	* Constructor
	*
	*/
	function Cron_Manager_Edit_Fns()
	{
		$this->Asset_Edit_Fns();

		$this->static_screens = Array(
									'details'		=> Array(
														'name'			=> translate('view_jobs'),
														'force_unlock'	=> FALSE,
													   ),
									'permissions'	=> Array(
														'name'			=> translate('permissions'),
														'force_unlock'	=> TRUE,
													   ),
									'logs'			=> Array(
														'name'			=> translate('logs'),
														'force_unlock'	=> TRUE,
													   ),
								);

		unset($this->static_screens['settings']);
		unset($this->static_screens['preview']);
		unset($this->static_screens['lookupValues']);
		unset($this->static_screens['web_paths']);
		unset($this->static_screens['metadata']);
		unset($this->static_screens['metadataSchemas']);
		unset($this->static_screens['workflow']);
		unset($this->static_screens['tagging']);
		unset($this->static_screens['roles']);
		unset($this->static_screens['permissions']);

	}//end constructor


	/**
	* Prints the jobs interface
	*
	* @param object	&$cron_mgr	the owning asset
	* @param string	$one_off	whether we are after one_off options or repeating
	*
	* @return array
	* @access public
	*/
	function getWhenBoxHoursMins(&$cron_mgr, $one_off)
	{
		$repeating = !$one_off; // for easier reading

		$options = Array(
					'mins'	=> Array(),
					'hours'	=> Array(),
				   );

		$one_hour = 60 * 60;
		$one_day  = 24 * $one_hour;

		$refresh_secs  = (int) $cron_mgr->attr('refresh_time');
		$refresh_mins  = floor($refresh_secs  / 60);
		$refresh_hours = floor($refresh_mins  / 60);

		$epoch_date    = getdate($cron_mgr->attr('epoch'));

		// how often in an hour do we refresh
		if ($refresh_mins == 0) {
			$num_refreshes = 60;
		} else if ($refresh_mins >= 60) {
			$num_refreshes = 1;
		} else {
			$num_refreshes = floor(60 / $refresh_mins);
		}

		if ($one_off) {
			for ($i = $epoch_date['minutes']; $i < $epoch_date['minutes'] + 60; $i+= (60 / $num_refreshes)) {
				$num = ($i >= 60) ? $i - 60 : $i;
				$options['mins'][] = str_pad($num, 2, '0', STR_PAD_LEFT);
			}
		} else if ($repeating) {
			// handle the minute option differently for a repeating (TI) job
			// showing minute options in the selection box as multiple of refresh time
			for ($i = 0; $i < 60; $i += (60 / $num_refreshes)) {
				$options['mins'][] = $i;
			}
		}
		sort($options['mins']);

		// how often in an day do we refresh
		if ($refresh_hours == 0) {
			$num_refreshes = 24;
		} else if ($refresh_hours >= 24) {
			$num_refreshes = 1;
		} else {
			$num_refreshes = floor(24 / $refresh_hours);
		}

		if ($one_off) {
			for ($i = $epoch_date['hours']; $i < $epoch_date['hours'] + 24; $i+= (24 / $num_refreshes)) {
				$num = ($i >= 24) ? $i - 24 : $i;
				$options['hours'][] = str_pad($num, 2, '0', STR_PAD_LEFT);
			}
		} else if ($repeating) {
			// handle the hour option differently for a repeating (TI) job
			// showing hour options in the selection box as multiple of refresh time
			for ($i = 0; $i < 24; $i += (24 / $num_refreshes)) {
				$options['hours'][] = $i;
			}
		}

		sort($options['hours']);

		return $options;

	}//end getWhenBoxHoursMins()


	/**
	* Prints the jobs interface
	*
	* @param object	&$asset	the asset to which we belong
	* @param object	&$o		the backend outputter object
	* @param string	$prefix	prefix for form elements
	*
	* @return boolean
	* @access public
	*/
	function paintJobs(&$asset, &$o, $prefix)
	{

		$jobs = $asset->getJobs('cron_job', FALSE);
		if (empty($jobs)) {
			$o->openField('');
				$o->note(translate('cron_no_jobs_registered'));
		} else {

			$whens = Array(
						'OO'	=> Array(),
						'ET'	=> Array(),
						'HR'	=> Array(),
						'DL'	=> Array(),
						'WK'	=> Array(),
						'MT'	=> Array(),
						'YR'	=> Array(),
					 );

			for ($i = 0, $total = count($jobs); $i < $total; $i++) {
				$w = $jobs[$i]->attr('when');
				$whens[substr($w, 0, 2)][$i] = $jobs[$i]->attr('when');
			}

			for (reset($whens); NULL !== ($type = key($whens)); next($whens)) {
				if (empty($whens[$type])) continue;
				asort($whens[$type], SORT_STRING);
				$o->openField(Cron_Job::whenTypeName($type), 'new_line');
				?>
				<table class="sq-backend-table">
					<tr>
						<td class="sq-backend-table-header">
							When
						</td>
						<td class="sq-backend-table-header">
							<?php echo translate('details'); ?>
						</td>
					<?php
						if ($asset->writeAccess('links')) {
						?>
						<td class="sq-backend-table-header" style="text-align: center;">
							<?php echo translate('delete_question'); ?>
						</td>
						<?php
						}//end if
					?>
					</tr>
				<?php

				foreach ($whens[$type] as $i => $when) {
				?>
					<tr>
						<td class="sq-backend-table-cell">
							<?php echo $jobs[$i]->readableWhen(FALSE); ?>
						</td>
						<td class="sq-backend-table-cell">
							<table border="0" cellspacing="0" cellpadding="0">
								<tr>
									<td class="sq-backend-table-cell" style="font-weight: bold; text-align: right; border-bottom: none">
										<?php echo translate('name'); ?> :&nbsp;
									</td>
									<td class="sq-backend-table-cell" style="border-bottom: none">
										<?php echo get_asset_tag_line($jobs[$i]->id); ?>
									</td>
								</tr>
								<tr>
									<td class="sq-backend-table-cell" style="font-weight: bold; text-align: right; border-bottom: none">
										<?php echo translate('run_as'); ?> :&nbsp;
									</td>
									<td class="sq-backend-table-cell" style="border-bottom: none">
										<?php
											$user =& $jobs[$i]->getRunningUser();
											if ($user) {
												echo get_asset_tag_line($user->id);
											} else {
												?><em><?php echo translate('system'); ?></em><?php
											}
										?>
									</td>
								</tr>
								<?php
								if (($asset->attr('current_job') == $jobs[$i]->id) && ((int) $asset->attr('run_check') >= (int) $asset->attr('warn_after_num_run_checks'))) {
								?>
								<tr>
								<td colspan="2" class="sq-backend-table-cell" style="border-bottom: none"><span class="sq-backend-warning">This job appears to have deadlocked the Cron Manager</span></td>
								</tr>
								<?php
								}
								?>
							</table>
						</td>
					<?php
						if ($asset->writeAccess('links')) {
						?>
						<td class="sq-backend-table-cell" style="text-align: center;">
						<?php
							if ($jobs[$i]->canDelete()) {
								check_box($prefix.'_remove_jobs[]', $jobs[$i]->id);
							} else {
								echo '&nbsp;';
							}//end if
						?>
						</td>
						<?php
						}//end if
					?>
					</tr>
				<?php
				}//end foreach
			}//end for

			?>
			</table>
			<?php

		}//end else

		return TRUE;

	}//end paintJobs()


	/**
	* Processes the jobs interface
	*
	* @param object	&$asset	the asset to which we belong
	* @param object	&$o		the backend outputter object
	* @param string	$prefix	prefix for form elements
	*
	* @return boolean
	* @access public
	*/
	function processJobs(&$asset, &$o, $prefix)
	{
		if (empty($_POST[$prefix.'_remove_jobs'])) {
			return FALSE;
		}
		if (!$asset->writeAccess('links')) return FALSE;

		$jobs = $asset->getJobs('cron_job', FALSE);
		if (empty($jobs)) return FALSE;

		for ($i = 0, $total = count($jobs); $i < $total; $i++) {
			if (in_array($jobs[$i]->id, $_POST[$prefix.'_remove_jobs'])) {
				$asset->removeJob($jobs[$i]);
			}
		}

		return TRUE;

	}//end processJobs()


	/**
	* Yes getting the date time field requires it's own function because it is
	* such a pain to set-up
	*
	* @param object	&$asset	the asset to which we belong
	* @param string	$prefix	prefix for form elements
	*
	* @return object
	* @access private
	*/
	function _getEpochDateTimeField(&$asset, $prefix)
	{
		require_once SQ_FUDGE_PATH.'/datetime_field/datetime_field.inc';
		$epoch_date = getdate((int) $asset->attr('epoch'));

		$value_arr = Array(
						'y'	=> $epoch_date['year'],
						'm'	=> $epoch_date['mon'],
						'd'	=> $epoch_date['mday'],
						'h'	=> $epoch_date['hours'],
						'i'	=> $epoch_date['minutes'],
						's'	=> $epoch_date['seconds'],
					 );

		$date = getdate();
		$parameters = Array(
						'min'			=> '2003-01-01 00:00:00',
						'max'			=> ($date['year'] + 1).'-12-31 23:59:59',
						'allow_circa'	=> '0',
						'print_format'	=> 'd/m/y h:i:s',
						'show'			=> Array('y', 'm', 'd', 'h', 'i', 's'),
						'style'			=> Array(
											'y'	=> 's',
											'm'	=> 's',
											'd'	=> 's',
											'h'	=> 's',
											'i'	=> 's',
											's'	=> 's',
										   ),
					  );

		$value = '';
		$field =& new DateTime_Field($prefix.'_epoch', $value, $parameters);
		$value = $field->unitsArrayToStr($value_arr);
		$field->setValue($value);

		return $field;

	}//end _getEpochDateTimeField()


	/**
	* Prints the interface for editing the cron manager's Epoch
	*
	* @param object	&$asset	the asset to which we belong
	* @param object	&$o		the backend outputter object
	* @param string	$prefix	prefix for form elements
	*
	* @return boolean
	* @access public
	*/
	function paintEpoch(&$asset, &$o, $prefix)
	{
		$field = $this->_getEpochDateTimeField($asset, $prefix);

		// take into account lock, plus only root can edit
		if ($asset->writeAccess('attributes') && $GLOBALS['SQ_SYSTEM']->userRoot()) {
			$field->printField();
		} else {
			echo $field->format();
		}//end if

		$attr =& $asset->getAttribute('epoch');
		echo '<br />&nbsp;';
		$o->note($attr->description);

	}//end paintEpoch()


	/**
	* Processes the interface for editing the cron manager's Epoch
	*
	* @param object	&$asset	the asset to which we belong
	* @param object	&$o		the backend outputter object
	* @param string	$prefix	prefix for form elements
	*
	* @return boolean
	* @access public
	*/
	function processEpoch(&$asset, &$o, $prefix)
	{
		$field = $this->_getEpochDateTimeField($asset, $prefix);

		// take into account lock, plus only root can edit
		if ($asset->writeAccess('attributes') && $GLOBALS['SQ_SYSTEM']->userRoot()) {
			if ($field->processField()) {
				$value_arr = $field->strToUnitsArray($field->value);
				$epoch = mktime($value_arr['h'], $value_arr['i'], $value_arr['s'], $value_arr['m'], $value_arr['d'], $value_arr['y']);
				return $asset->setAttrValue('epoch', $epoch);

			}//end if
		}//end if

		return FALSE;

	}//end processEpoch()


	/**
	* Prints the interface for showing when the cron manager last ran
	*
	* @param object	&$asset	the asset to which we belong
	* @param object	&$o		the backend outputter object
	* @param string	$prefix	prefix for form elements
	*
	* @return boolean
	* @access public
	*/
	function paintLastRun(&$asset, &$o, $prefix)
	{
		echo $GLOBALS['SQ_SYSTEM']->datetime((int) $asset->attr('last_run'));

	}//end paintLastRun()


	/**
	* Prints the interface for showing whether the cron manager is currently running or not
	*
	* @param object	&$asset	the asset to which we belong
	* @param object	&$o		the backend outputter object
	* @param string	$prefix	prefix for form elements
	*
	* @return boolean
	* @access public
	*/
	function paintDeadLockStatus(&$asset, &$o, $prefix)
	{
		// if we have a suspicion of being in DeadLock, then allow them to override
		if ($asset->attr('running') && (int) $asset->attr('run_check') >= (int) $asset->attr('warn_after_num_run_checks')) {
			$o->openField('<div class="sq-backend-warning" style="text-align: center;">POTENTIAL CRON MANAGER DEAD LOCK DETECTED</div>', 'new_line');
			if ($GLOBALS['SQ_SYSTEM']->userRoot()) {
				if ($asset->writeAccess('all')) {
					$current_job_id = $asset->attr('current_job');
					?>
					<table border="0">
						<tr>
							<td class="sq-backend-data">
								<?php echo translate('cron_deadlock_warning_section_1', $asset->attr('warn_after_num_run_checks')); ?>
								<ol class="sq-backend-data">
									<li class="sq-backend-data"><?php echo translate('cron_deadlock_warning_list_item_1'); ?></li>
									<li class="sq-backend-data"><?php echo translate('cron_deadlock_warning_list_item_2'); ?></li>
								</ol>

								<?php
								if (!empty($current_job_id)) {
								?>
								<p class="sq-backend-data">
									<?php echo translate('cron_deadlock_warning_offending_job', get_asset_tag_line($current_job_id)); ?>
								</p>
								<?php
								}
								?>
								<?php echo translate('cron_deadlock_warning_check_error_log', hide_system_root(SQ_LOG_PATH).'/'.$asset->error_log_file_name.SQ_CONF_LOG_EXTENSION); ?>
								<p class="sq-backend-data"><?php echo translate('cron_deadlock_warning_section_2'); ?></p>
								<p class="sq-backend-data">
								<b><?php echo translate('cron_deadlock_warning_section_3'); ?></b>
								</p>
							</td>
						</tr>
						<tr>
							<td valign="top" class="sq-backend-data">
								<?php
									check_box($prefix.'_force_remove_lock');
									label(translate('cron_force_lock_removal'));
								?>
							</td>
						</tr>
						<tr>
							<td valign="top" class="sq-backend-data">
								<?php security_key(25, 30, 2, TRUE); ?>
							</td>
						</tr>
					</table>
					<?php
				} else {
					echo translate('cron_deadlock_must_acquire_lock');
				}
			} else {
				echo translate('cron_deadlock_warning_contact_root');
			}//end if

		// else everything is OK
		} else {
			$o->openField(translate('cron_manager_appears_to_be_fine'), 'new_line');

		}//end if run_check

		return TRUE;

	}//end paintDeadLockStatus()


	/**
	* Processes the interface for showing whether the cron manager is currently running or not
	*
	* @param object	&$asset	the asset to which we belong
	* @param object	&$o		the backend outputter object
	* @param string	$prefix	prefix for form elements
	*
	* @return boolean
	* @access public
	*/
	function processDeadLockStatus(&$asset, &$o, $prefix)
	{
		if (empty($_POST[$prefix.'_force_remove_lock'])) {
			return FALSE;
		}

		if ($asset->attr('running') && (int) $asset->attr('run_check') >= (int) $asset->attr('warn_after_num_run_checks')) {
			// if we have a suspicion of being in DeadLock, then allow them to override
			if ($GLOBALS['SQ_SYSTEM']->userRoot() && $asset->writeAccess('all')) {
				if (validate_security_key()) {
					$asset->setAttrValue('running', FALSE);
					$asset->setAttrValue('run_check', 0);
					return TRUE;

				} else {
					trigger_localised_error('CRON0013', E_USER_NOTICE);
				}//end if
			}//end if
		}//endif

		return FALSE;

	}//end processDeadLockStatus()


	/**
	* Paints the 'excluded time' rule
	*
	* @param object	&$asset	the asset whose interface we are painting
	* @param object	&$o		the outputter class
	* @param string	$prefix	prefix for the form elements
	*
	* @return void
	* @access private
	*/
	function paintExcludedTime(&$asset, &$o, $prefix)
	{
		$hours_array = Array(
						0	=> '00',
						1	=> '01',
						2	=> '02',
						3	=> '03',
						4	=> '04',
						5	=> '05',
						6	=> '06',
						7	=> '07',
						8	=> '08',
						9	=> '09',
						10	=> '10',
						11	=> '11',
						12	=> '12',
						13	=> '13',
						14	=> '14',
						15	=> '15',
						16	=> '16',
						17	=> '17',
						18	=> '18',
						19	=> '19',
						20	=> '20',
						21	=> '21',
						22	=> '22',
						23	=> '23',
					   );
		$days_array = Array(
						0	=> translate('sunday'),
						1	=> translate('monday'),
						2	=> translate('tuesday'),
						3	=> translate('wednesday'),
						4	=> translate('thursday'),
						5	=> translate('friday'),
						6	=> translate('saturday'),
					  );

		$write_access = $asset->writeAccess('all') && $GLOBALS['SQ_SYSTEM']->userRoot();

		$exclude_times = $asset->attr('exclude_times');

		if ($write_access || !empty($exclude_times)) {
		?>
		<table class="sq-backend-table">
				<tr>
					<th class="sq-backend-table-header"><?php echo translate('cron_excluded_time') ?></th>
					<?php
						if ($write_access) {
							?><th class="sq-backend-table-header"><?php echo translate('delete') ?></th><?php
						}
					?>
				</tr><?php

		}

		if ($write_access) {

			foreach ($exclude_times as $key => $details) {
				?>
				<tr>
				<?php
				$field_prefix = $prefix.'_exlude_times['.$key.']';
				ob_start();
					combo_box($field_prefix.'[from]', $hours_array, FALSE, $details['from']);
					$from = ob_get_contents();
				ob_end_clean();
				ob_start();
					combo_box($field_prefix.'[to]', $hours_array, FALSE, $details['to']);
					$to = ob_get_contents();
				ob_end_clean();
				ob_start();
					combo_box($field_prefix.'[days]', $days_array, TRUE, $details['days']);
					$days = ob_get_contents();
				ob_end_clean();
				?><td class="sq-backend-table-cell"><?php
					echo translate('cron_excluded_time_hour', $from, $to);
					echo translate('cron_excluded_time_days', $days);
				?></td><td class="sq-backend-table-cell"><?php
					check_box($field_prefix.'[delete]', TRUE, FALSE);?></td></tr><?php
			}

			?>
			<tr><td colspan="2">Add <?php check_box($prefix.'_add_exclude_time', TRUE, FALSE); ?></tr>
			<?php

		} else {
			if (!empty($exclude_times)) {

				foreach ($exclude_times as $key => $details) {
					?>
					<tr>
					<?php
					$from = $hours_array[$details['from']];
					$to = $hours_array[$details['to']];
					if (!empty($details['days'])) {
						$selected_days = Array();
						foreach ($details['days'] as $day) {
							$selected_days[] = $days_array[$day];
						}
						$days = implode(', ', $selected_days);
					}
					?><td class="sq-backend-table-cell" colspan="2"><?php
						echo translate('cron_excluded_time_hour', $from, $to);
						if (!empty($days)) {
							if (count($selected_days) == 7) {
								echo translate('cron_excluded_time_every_day');
							} else {
								echo translate('cron_excluded_time_days', $days);
							}
						}
					?></td></tr><?php
				}
			} else {
				echo translate('cron_excluded_not_specified');
			}
		}

		if ($write_access || !empty($exclude_times)) {
			?></table><?php
		}

	}//end paintExcludedTime()


	/**
	* Processes the 'excluded time' rule
	*
	* @param object	&$asset	the asset whose interface we are painting
	* @param object	&$o		the outputter class
	* @param string	$prefix	prefix for the form elements
	*
	* @return void
	* @access private
	*/
	function processExcludedTime(&$asset, &$o, $prefix)
	{
		$modified = FALSE;

		$exlude_times = Array();
		if (isset($_POST[$prefix.'_exlude_times'])) {
			$modified = TRUE;
			foreach ($_POST[$prefix.'_exlude_times'] as $key => $exclude_period) {
				if (isset($_POST[$prefix.'_exlude_times'][$key]['delete'])) {
					continue;
				}

				if (!isset($exclude_period['days'])) {
					$exclude_period['days'] = Array();
				}

				$exlude_times[] = $exclude_period;
			}
		}

		if (isset($_POST[$prefix.'_add_exclude_time'])) {
			$modified = TRUE;
			$new_exclude_time = Array();
			$new_exclude_time['from'] = 0;
			$new_exclude_time['to'] = 0;
			$new_exclude_time['days'] = Array();
			$exlude_times[] = $new_exclude_time;

		}

		if ($modified) {
			return $asset->setAttrValue('exclude_times', $exlude_times);
		}

		return FALSE;

	}//end processExcludedTime()


}//end class
?>

<?php
/**
* +--------------------------------------------------------------------+
* | Squiz.net Open Source Licence                                      |
* +--------------------------------------------------------------------+
* | Copyright (c), 2003 Squiz Pty Ltd (ABN 77 084 670 600).            |
* +--------------------------------------------------------------------+
* | This source file may be used subject to, and only in accordance    |
* | with, the Squiz Open Source Licence Agreement found at             |
* | http://www.squiz.net/licence.                                      |
* | Make sure you have read and accept the terms of that licence,      |
* | including its limitations of liability and disclaimers, before     |
* | using this software in any way. Your use of this software is       |
* | deemed to constitute agreement to be bound by that licence. If you |
* | modify, adapt or enhance this software, you agree to assign your   |
* | intellectual property rights in the modification, adaptation and   |
* | enhancement to Squiz Pty Ltd for use and distribution under that   |
* | licence.                                                           |
* +--------------------------------------------------------------------+
*
* $Id: design_area_menu_stalks.inc,v 1.21.2.1 2005/10/27 01:18:43 sdanis Exp $
*
*/


require_once SQ_CORE_PACKAGE_PATH.'/designs/design_areas/menu/design_area_menu_recursive/design_area_menu_recursive.inc';

/**
* Design_Area_Menu_Stalks
*
* Purpose
*
*
* @author  Blair Robertson <blair@squiz.net>
* @version $Revision: 1.21.2.1 $
* @package MySource_Matrix_Packages
* @subpackage __core__
*/
class Design_Area_Menu_Stalks extends Design_Area_Menu_Recursive
{
	/**
	* The width of the arrow image
	* @var int
	*/
	var $arrow_width  = 4;

	/**
	* The height of the arrow image
	* @var int
	*/
	var $arrow_height = 6;


	/**
	* Set the value for the passed variable to the passed value
	*
	* @param string		$name				the name of the attribute
	* @param string		$value				the new value of the attribute
	*
	* @return boolean
	* @access public
	*/
	function setAttrValue($name, $value)
	{
		// make sure the aligment is lower case
		switch ($name) {
			case 'alignment' :
				$value = strtolower($value);
				break;

			case 'min_height' :
				$value = (int) $value;
				if ($value <= 0) {
					trigger_localised_error('CORE0177', E_USER_WARNING, $name);
					return false;
				}
				break;
		}//end switch

		return parent::setAttrValue($name, $value);

	}//end setAttrValue()


	/**
	* Prints the recursive fn that will be used by this menu to printout its details
	* NOTE: to be overridden by our children
	*
	* @param object Design	$design			the design for which we are currently printing
	*
	* @access public
	*/
	function printRecursiveFn(&$design)
	{
		$use_blanks  = !$this->attr('show_stalks');
		$cell_class = '';
		if ($this->settingExists('class')) {
			ob_start();
			$this->printVar('settings.class', Array());
			$cell_class = ' class="'.ob_get_contents().'"';
			ob_end_clean();
		}//end if


		ob_start();
		echo '
				<td'.$cell_class.' style="vertical-align: top;"><img alt="" src="';
		if ($use_blanks) {
			echo '<', '?php echo $blank_src; ?', '>';
		} else {
			echo '<', '?php echo (($'.$this->attr('id_name').'_current_setting == \'current\') ? $stalk_prefix.\'arrow.png\' : $blank_src); ?', '>';

		}
		echo '" width="'.$this->arrow_width.'" height="'.$this->attr('min_height').'" /></td>';
		$arrow_contents = ob_get_contents();
		ob_end_clean();



		ob_start();
		if ($asset_contents = $this->attr('asset_contents')) {
			$edit_fns = $this->getEditFns();
			$this->_tmp['outputting_asset_section'] = true;
			if (!$edit_fns->_outputContents($asset_contents, $this, $design)) return false;
			unset($this->_tmp['outputting_asset_section']);
		}//	end if

		$asset_contents = '
				<td'.$cell_class.' style="width: 100%; vertical-align: top; text-align: '.$this->attr('alignment').';'.(($this->attr('word_wrap')) ? '' : ' white-space: nowrap;').'">'.ob_get_contents().'</td>
		';
		ob_end_clean();

		// if we are using ellipsis, then we need to include general/general.inc
		if ($this->attr('ellipsis_length') > 0) {
			echo 'require_once SQ_FUDGE_PATH.\'/general/general.inc\';';
		}

		echo '

		function '.$this->attr('id_name').'_recursive_fn($level, $parentid, $'.$this->attr('id_name').'_base_url, $depth=Array())
		{
			global $RECURSIVE_MENU_ASSET_LINEAGE;
			static $'.$this->attr('id_name').'_settings = '.var_export($this->_getSettingsArray(), true).';

			$blank_src    = sq_web_path(\'lib\').\'/web/images/blank.gif\';
			$stalk_prefix = sq_web_path(\'data\').\'/assets/'.$this->type().'/'.$this->id.'/\';

			// The indenting level, stalk on/off
			$depth[] = true;
			$depth_count = count($depth);

			$'.$this->attr('id_name').'_lineage_assetid = (empty($RECURSIVE_MENU_ASSET_LINEAGE[$level + 1])) ? 0 : $RECURSIVE_MENU_ASSET_LINEAGE[$level + 1][\'assetid\'];
			$'.$this->attr('id_name').'_lineage_setting = (count($RECURSIVE_MENU_ASSET_LINEAGE) - 1 == $level + 1) ? \'current\' : \'hierarchy\';
			$'.$this->attr('id_name').'_urls = $GLOBALS[\'SQ_SYSTEM\']->am->getAssetURL(array_keys($GLOBALS[\'MENU_DATA\'][$parentid]), $'.$this->attr('id_name').'_base_url);

#			pre_echo("Lineage Setting : $'.$this->attr('id_name').'_lineage_setting");
#			pre_echo("Lineage Assetid : $'.$this->attr('id_name').'_lineage_assetid");
			$num_kids = count($GLOBALS[\'MENU_DATA\'][$parentid]);
			$i = 0;
			foreach ($GLOBALS[\'MENU_DATA\'][$parentid] as $'.$this->attr('id_name').'_row) {
				$i++;
				$end = ($i == $num_kids);
				// if not live, we have to get the proper object, sorry
				if (((int) $'.$this->attr('id_name').'_row[\'status\'] & SQ_STATUS_LIVE) == 0) {
					$'.$this->attr('id_name').'_obj = &$GLOBALS[\'SQ_SYSTEM\']->am->getAsset($'.$this->attr('id_name').'_row[\'assetid\'], $'.$this->attr('id_name').'_row[\'type_code\']);
				} else {
					unset($'.$this->attr('id_name').'_obj);
				}
				$'.$this->attr('id_name').'_current_setting = ($'.$this->attr('id_name').'_lineage_assetid == $'.$this->attr('id_name').'_row[\'assetid\']) ? $'.$this->attr('id_name').'_lineage_setting : \'normal\';
#				pre_echo("CURRENT SETTING : ".$'.$this->attr('id_name').'_current_setting);
			?', '>
			<div style="text-align: '.$this->attr('alignment').';">
			<table cellpadding="0" cellspacing="0" border="0" width="100%">
				<tr>
			';

		if ($this->attr('alignment') == 'right') echo $asset_contents;

		if ($this->attr('indent')) {

			if ($this->attr('alignment') == 'right') echo $arrow_contents;

			echo '
			<', '?php
			';

			// depending on the alignment differs how we loop through the array
			if ($this->attr('alignment') == 'left') {
				echo '
				for ($j = 0; $j < $depth_count; $j++) {
				';
			} else {
				echo '
				for ($j = $depth_count - 1; $j >= 0; $j--) {
				';
			}

			echo '?', '>
					<td'.$cell_class.' style="vertical-align: top;"';

					if ($use_blanks) {
						echo '><img alt="" src="<', '?php echo $blank_src; ?', '>" width="'.$this->attr('indent').'" height="'.$this->attr('min_height').'" /></td>';
					} else {
						// if there is the need to a stalk
						// and if we are at the end of a sub listing and
						// not it the indent closest to the text (which will have the end branch)
						echo '<', '?php
						if ($depth[$j] && !($end && ($j == $depth_count - 1)))
							echo \' style="background-image:url(\', $stalk_prefix, \'stalk.png); background-repeat: repeat-y;"\';

						?', '>><img alt="" src="<', '?php
						if ($j != $depth_count - 1) {
							echo $blank_src.\'"\';
						} elseif ($end) {
							echo $stalk_prefix, \'endbranch.png"\';
						} else {
							echo $stalk_prefix, \'branch.png"\';
						}

						?', '> width="'.$this->attr('indent').'" height="'.$this->attr('min_height').'" /></td>';

					}//end if $use_blanks
		echo '
				<', '?php
				}//end for depth count

			?', '>';

			if ($this->attr('alignment') == 'left') echo $arrow_contents;

		}//end indent

		if ($this->attr('alignment') == 'left') echo $asset_contents;

		echo '

					</tr>
				</table>
				</div>
				<', '?php

			';

		// if we are to show a minimum number of levels, add an extra bit to the condition

		$recurse_condition = '$'.$this->attr('id_name').'_current_setting != \'normal\'';


		if ($this->attr('min_num_levels') > 0) {
			$recurse_condition = '$level < '.($this->attr('min_num_levels') + $this->attr('level') - 1).' || '.$recurse_condition;
		}

		if ($this->attr('max_num_levels') > 0) {
			$recurse_condition = '$level < '.($this->attr('max_num_levels') + $this->attr('level') - 1).' && ('.$recurse_condition.')';
		}
		echo '
				if (('.$recurse_condition.') && !empty($GLOBALS[\'MENU_DATA\'][$'.$this->attr('id_name').'_row[\'assetid\']])) {
					if ($end) $depth[$depth_count - 1] = false;
					'.$this->attr('id_name').'_recursive_fn($level + 1, $'.$this->attr('id_name').'_row[\'assetid\'], $'.$this->attr('id_name').'_urls[$'.$this->attr('id_name').'_row[\'assetid\']], $depth);
				} // end if

			}//end for

		}//end '.$this->attr('id_name').'_recursive_fn()

		';

	}//end printRecursiveFn()


	/**
	* Outputs either the straight HTML or PHP code that is needed for this design area to be represented
	*
	* @param object Design	$design the design for which we are currently printing
	*
	* @return boolean
	* @access public
	*/
	function printArea(&$design)
	{
		if ($this->attr('show_stalks') && $this->attr('indent') && $this->attr('min_height')) {
			$edit_fns = $this->getEditFns();
			if (!$edit_fns->_createStalkImages($this)) return false;
		}

		return parent::printArea($design);

	}//end printArea()


}//end class
?>

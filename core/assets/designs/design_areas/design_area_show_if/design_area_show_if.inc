<?php
/**
* +--------------------------------------------------------------------+
* | Squiz.net Open Source Licence                                      |
* +--------------------------------------------------------------------+
* | Copyright (c), 2003 Squiz Pty Ltd (ABN 77 084 670 600).            |
* +--------------------------------------------------------------------+
* | This source file may be used subject to, and only in accordance    |
* | with, the Squiz Open Source Licence Agreement found at             |
* | http://www.squiz.net/licence.                                      |
* | Make sure you have read and accept the terms of that licence,      |
* | including its limitations of liability and disclaimers, before     |
* | using this software in any way. Your use of this software is       |
* | deemed to constitute agreement to be bound by that licence. If you |
* | modify, adapt or enhance this software, you agree to assign your   |
* | intellectual property rights in the modification, adaptation and   |
* | enhancement to Squiz Pty Ltd for use and distribution under that   |
* | licence.                                                           |
* +--------------------------------------------------------------------+
*
* $Id: design_area_show_if.inc,v 1.12 2006/02/27 04:28:37 bcaldwell Exp $
*
*/


require_once SQ_CORE_PACKAGE_PATH.'/designs/design_area/design_area.inc';

/**
* Design_Area_Show_If
*
* Purpose
*	Show different content depending on certain conditions evaluated at runtime
*
* @author  Avi Miller <Avi Miller@squiz.net>
* @version $Revision: 1.12 $
* @package MySource_Matrix_Packages
* @subpackage __core__
*/
class Design_Area_Show_If extends Design_Area
{


	/**
	* Queue the setting of the value of an attribute
	*
	* @param string	$name	the name of the attribute
	* @param string	$value	the new value of the attribute
	*
	* @return boolean
	* @access public
	* @see asset:setAttrValue()
	*/
	function setAttrValue($name, $value)
	{
		if ((substr($name, 0, 10) == 'condition_') && ($name != 'condition_data')) {
			// this is some condition data we need to save and pass to the
			//  condition asset's evaluate() function
			$data_key = substr($name, 10);

			$condition_data = $this->attr('condition_data');
			$condition_data[$data_key] = $value;
			return parent::setAttrValue('condition_data', $condition_data);
		} else {
			return parent::setAttrValue($name, $value);
		}

	}//end setAttrValue()


	/**
	* Print code that initialises this design area and should always be printed in place of the AREA tag
	*
	* This function can be overridden by children
	*
	* @return void
	* @access protected
	*/
	function _printInitCode()
	{
		$condition = $this->attr('condition');
		$condition_data = $this->attr('condition_data');
		$condition_data['id_name'] = $this->attr('id_name');
		$id_name = $this->attr('id_name');
		$cond_var_name = '$'.$this->attr('id_name').'_condition_result';
		echo '<','?php
		$GLOBALS[\'SQ_SYSTEM\']->am->includeAsset(\'condition_'.$condition.'\');
		$'.$id_name.'_condition_data = '.var_export($condition_data, TRUE).';
		'.$cond_var_name.' = condition_'.$condition.'::evaluate($ASSET, $'.$id_name.'_condition_data);';
		echo '?', '>
		';

	}//end _printInitCode()


	/**
	* Print code that actually results in HTML output to the browser for this design area
	*
	* This function is called at the AREA tag if print != no, and at the point of any PRINT
	* tags that reference this area.
	*
	* @return void
	* @access protected
	*/
	function _printPaintingCode()
	{
		$then = $this->attr('then_contents');
		$else = $this->attr('else_contents');
		$cond_var_name = '$'.$this->attr('id_name').'_condition_result';

		echo '<','?php';
		echo '
			if ('.$cond_var_name.') {
		';

		// the multiple echo statements are required to get content to print at line 1,
		// character 1 of the potential output (i.e. the DocType). Otherwise, it may get
		// ignored
		if (!empty($then)) {
			echo '?', '>'."\n";
			foreach ($then as $index => $element) {
				$this->_printContentItemCode($element);
			}
			echo '<', '?php ; '."\n";
		} else {
			echo 'echo \'\';'."\n";
		}

		echo '} else {'."\n";

		if (!empty($else)) {
			echo '?', '>'."\n";
			foreach ($else as $index => $element) {
				$this->_printContentItemCode($element);
			}
			echo '<', '?php ; ';
		} else {
			echo 'echo \'\';';
		}

		echo '}
		?','>
		';
		return TRUE;

	}//end _printPaintingCode()


	/**
	* Returns true if this content generated by this design area can be cached
	*
	* @return boolean
	* @access public
	*/
	function canBeCached()
	{
		return FALSE;

	}//end canBeCached()


	/**
	* Get the names of attributes for this DA that cannot be set in the parse file
	*
	* Design Area attributes that are not mentioned in the parse file are normally set to defaults
	* when parsing the design.  Attributes returned by this function are exempted from that process.
	*
	* @return array
	* @access public
	*/
	function getProtectedAttrs()
	{
		$attrs = parent::getProtectedAttrs();
		$attrs[] = 'condition_data';
		return $attrs;

	}//end getProtectedAttrs()


}//end class
?>
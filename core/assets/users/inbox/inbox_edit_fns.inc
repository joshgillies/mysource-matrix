<?php
/**
* +--------------------------------------------------------------------+
* | Squiz.net Open Source Licence                                      |
* +--------------------------------------------------------------------+
* | Copyright (c), 2003 Squiz Pty Ltd (ABN 77 084 670 600).            |
* +--------------------------------------------------------------------+
* | This source file may be used subject to, and only in accordance    |
* | with, the Squiz Open Source Licence Agreement found at             |
* | http://www.squiz.net/licence.                                      |
* | Make sure you have read and accept the terms of that licence,      |
* | including its limitations of liability and disclaimers, before     |
* | using this software in any way. Your use of this software is       |
* | deemed to constitute agreement to be bound by that licence. If you |
* | modify, adapt or enhance this software, you agree to assign your   |
* | intellectual property rights in the modification, adaptation and   |
* | enhancement to Squiz Pty Ltd for use and distribution under that   |
* | licence.                                                           |
* +--------------------------------------------------------------------+
*
* $Id: inbox_edit_fns.inc,v 1.33.2.1 2005/01/05 04:21:18 gsherwood Exp $
* $Name: not supported by cvs2svn $
*/


require_once SQ_INCLUDE_PATH.'/asset_edit/asset_edit_fns.inc';
require_once SQ_LIB_PATH.'/html_form/html_form.inc';

/**
* Inbox_Edit_Fns
*
* Purpose
*
*
* @author  Greg Sherwood <greg@squiz.net>
* @version $Version$ - 1.0
* @package MySource_Matrix_Packages
* @subpackage __core__
*/
class Inbox_Edit_Fns extends Asset_Edit_Fns
{

	/**
	* Constructor
	*
	*/
	function Inbox_Edit_Fns()
	{
		$this->Asset_Edit_Fns();

		$this->static_screens = Array(	'details'		=> Array(
															'name'			=> 'Inbox',
															'use_tab'		=> true,
															'force_unlock'	=> false,
															'lock_type'		=> 'mail',
															),
									);

	}//end constructor


	/**
	* Prints the message with the passed ID
	*
	* @param int	$messageid	the ID of the message to print
	*
	* @return boolean
	* @access public
	*/
	function paintMessage($messageid)
	{
		// get the message we are printing
		$ms = &$GLOBALS['SQ_SYSTEM']->getMessagingService();
		$message = $ms->getMessageById($messageid);

		// mark the message as read
		if ($message->status == SQ_MSG_UNREAD) {
			$message->updateStatus(SQ_MSG_READ);
		}

		return $message->printBody();

	}//end paintMessage()


	/**
	* Prints the inbox interface
	*
	* @param object File				&$asset	the file asset
	* @param object Backend_Outputter	&$o		the backend outputter
	* @param string						$prefix	prefix for form elements
	*
	* @return boolean
	* @access public
	*/
	function paintMail(&$asset, &$o, $prefix)
	{
		$user = &$asset->_getUser();

		$ms = &$GLOBALS['SQ_SYSTEM']->getMessagingService();
		$messages = $ms->getMessages($user->id, null, Array(SQ_MSG_UNREAD, SQ_MSG_READ), Array(), null, null, 'name');
		$write_access = $asset->writeAccess('mail');

		if (empty($messages)) {
			echo 'You have no messages';
		} else {
			?>
			<script type="text/javascript" language="Javascript">
				function showMessageBody(messageid) {
					var iframe = document.getElementById('sq_message_body');
					if (iframe == null) return;
					
					var url='<?php echo $_SERVER['PHP_SELF']; ?>' + '?a=<?php echo $asset->id; ?>&msgid=' + messageid;
					iframe.src = url;
				}
			</script>

			<table border="0" cellspacing="0" cellpadding="1" width="100%">
			<tr>
				<td colspan="<?php echo ($write_access) ? '5' : '4';?>" background="<?php echo sq_web_path('lib'); ?>/web/images/section_dots.gif" style="height:1px; padding:0px; margin:0px;"><img src="<?php echo sq_web_path('lib'); ?>/web/images/blank.gif" width="1" height="1" /></td>
			</tr>
			<tr>
				<td class="sq-backend-table-header">FROM</td>
				<td class="sq-backend-table-header">SUBJECT</td>
				<td class="sq-backend-table-header">SENT</td>
				<td class="sq-backend-table-header">
					<?php
					if ($write_access) {
						check_box($prefix.'_select_all_read', '1', false, "check_all(document.main_form, '{$prefix}_mark_as_read', this.checked);");
					}
					?>
					READ
				</td>
				<?php
				if ($write_access) {
					?>
					<td class="sq-backend-table-header">
						<?php check_box($prefix.'_select_all_delete', '1', false, "check_all(document.main_form, '{$prefix}_delete', this.checked);"); ?>
						DELETE
					</td>
					<?php
				}
				?>
			</tr>
			<?php
			$alt = false;
			$num_printed = 0;
			$num_per_page = 10;
			$num_messages = count($messages);
			$start_printing_at = 0;
			if (isset($_REQUEST['sq_internal_message_inbox_start'])) $start_printing_at = (int) $_REQUEST['sq_internal_message_inbox_start'];

			for ($i = 0; $i < $num_messages; $i++) {
				if ($i < $start_printing_at) {
					$i++;
					continue;
				}

				$data = $messages[$i];

				if ($alt) $alt = false;
				else $alt = true;
				$class = 'sq-backend-table-cell'.(($alt) ? '-alt' : '');

				// work out the time of day icon
				if (date('A',$data['sent']) == 'AM') $time_img = sq_web_path('lib').'/web/images/icons/internal_message/clock_day.png';
				else $time_img = sq_web_path('lib').'/web/images/icons/internal_message/clock_night.png';
				
				// work out the sender icon
				$sender_img = $GLOBALS['SQ_SYSTEM']->am->getAssetIconURL($data['type_code']);
				?>
				<tr>
					<td class="<?php echo $class ?>" nowrap>
						<script language="JavaScript" type="text/javascript">sq_print_icon("<?php echo sq_web_path('lib'); ?>/web/images/icons/internal_message/priority_<?php echo $data['priority'];?>.png", "16", "16", "");</script>
						<script language="JavaScript" type="text/javascript">sq_print_icon("<?php echo $sender_img; ?>", "16", "16", "");</script>
						<a name="msg_<?php echo $data['msgid'];?>"></a>
						&nbsp;<?php echo $data['from_name'];?>
						<?php hidden_field($prefix.'_messages['.$data['msgid'].']', '1'); ?>
					</td>
					<td class="<?php echo $class ?>">
						<script language="JavaScript" type="text/javascript">sq_print_icon("<?php echo sq_web_path('lib'); ?>/web/images/icons/internal_message/message_subject.png", "16", "16", "");</script>
						&nbsp;<a href="#" onClick="Javascript: showMessageBody('<?php echo $data['msgid'];?>'); return false;" style="text-decoration:none;"><?php echo $data['subject'];?></a>
					</td>
					<td class="<?php echo $class ?>" nowrap>
						<script language="JavaScript" type="text/javascript">sq_print_icon("<?php echo $time_img; ?>", "16", "16", "");</script>
						&nbsp;<?php echo $GLOBALS['SQ_SYSTEM']->datetime($data['sent']); ?>
					</td>
					<td class="<?php echo $class ?>" nowrap>
						<?php
						if ($asset->writeAccess('mail')) {
							check_box($prefix.'_mark_as_read['.$data['msgid'].']', '1', ($data['status'] == SQ_MSG_READ));
						}
						?>
						&nbsp;<script language="JavaScript" type="text/javascript">sq_print_icon("<?php echo sq_web_path('lib'); ?>/web/images/icons/internal_message/message_<?php echo (($data['status'] == SQ_MSG_UNREAD) ? 'un' : ''); ?>read.png", "16", "16", "");</script>
					</td>
					<?php
					if ($write_access) {
						?>
						<td class="<?php echo $class ?>" nowrap>
							<?php check_box($prefix.'_delete['.$data['msgid'].']'); ?>
						</td>
						<?php
					}
					?>
				</tr>
				<tr>
					<td colspan="<?php echo ($write_access) ? '5' : '4';?>"><img src="<?php echo sq_web_path('lib'); ?>/web/images/blank.gif" width="1" height="1" /></td>
				</tr>
				<tr>
					<td colspan="<?php echo ($write_access) ? '5' : '4';?>" background="<?php echo sq_web_path('lib'); ?>/web/images/section_dots.gif" style="height:1px; padding:0px; margin:0px;"><img src="<?php echo sq_web_path('lib'); ?>/web/images/blank.gif" width="1" height="1" /></td>
				</tr>
				<tr>
					<td colspan="<?php echo ($write_access) ? '5' : '4';?>"><img src="<?php echo sq_web_path('lib'); ?>/web/images/blank.gif" width="1" height="1" /></td>
				</tr>
				<?php
				$num_printed++;
				if ($num_printed >= $num_per_page) break;
			}
			?>
				<tr>
					<td colspan="<?php echo ($write_access) ? '5' : '4';?>" align="center" class="sq-backend-table-cell">
					<?php
					hidden_field('sq_internal_message_inbox_start', $start_printing_at);
					if ($start_printing_at > 0) {
						?><a style="text-decoration: none;" href="#" onClick="Javascript: set_hidden_field('sq_internal_message_inbox_start', '<?php echo $start_printing_at - $num_per_page; ?>'); set_hidden_field('process_form', '0'); submit_form(); return false;"><?php
					} else {
						?><span style="color: #BBBBBB"><?php
					}
					?>
					<< Previous Page
					<?php
					if ($start_printing_at > 0) {
						?></a><?php
					} else {
						?></span><?php
					}
					?>
					&nbsp;<b>Page <?php echo round(($start_printing_at + $num_per_page) / $num_per_page); ?> of <?php echo round(($num_messages / $num_per_page) + 0.5); ?></b>&nbsp;
					
					<?php
					if (($start_printing_at + $num_per_page) < $num_messages) {
						?><a style="text-decoration: none;" href="#" onClick="Javascript: set_hidden_field('sq_internal_message_inbox_start', '<?php echo $start_printing_at + $num_per_page; ?>'); set_hidden_field('process_form', '0'); submit_form(); return false;"><?php
					} else {
						?><span style="color: #BBBBBB"><?php
					}
					?>
					Next Page >>
					<?php
					if (($start_printing_at + $num_per_page) < $num_messages) {
						?></a><?php
					} else {
						?></span><?php
					}
					?>
					</td>
				</tr>
			</table>
			<p>
			<iframe src="" id="sq_message_body" width="100%" height="300" frameborder="1"></iframe>
			<?php
		}

		return $write_access;

	}//end paintMail()


	/**
	* Processes the inbox interface
	*
	* @param object Asset				$asset	the asset to which we belong
	* @param object	Backend_Outputter	$o		the outputter class
	* @param string						$prefix	prefix for the form element
	*
	* @return boolean
	* @access public
	*/
	function processMail(&$asset, &$o, $prefix)
	{
		$msgs   = (isset($_POST[$prefix.'_messages'])) ? array_keys($_POST[$prefix.'_messages']) : Array();
		$read   = (isset($_POST[$prefix.'_mark_as_read'])) ? array_keys($_POST[$prefix.'_mark_as_read']) : Array();
		$delete = (isset($_POST[$prefix.'_delete'])) ? array_keys($_POST[$prefix.'_delete']) : Array();

		$user = &$asset->_getUser();

		$ms = &$GLOBALS['SQ_SYSTEM']->getMessagingService();
		$messages = $ms->getMessages($user->id);

		if (!empty($messages)) {
			foreach ($messages as $data) {
				if (!in_array($data['msgid'], $msgs)) continue;
				$message = $ms->getMessageById($data['msgid']);

				// change message status (read/unread)
				if (in_array($data['msgid'], $read) && $data['status'] != SQ_MSG_READ) {
					if (!$message->updateStatus(SQ_MSG_READ)) {
						trigger_error('Status of message '.$data['msgid'].' was not updated', E_USER_WARNING);
					}
				} else if (!in_array($data['msgid'], $read) && $data['status'] == SQ_MSG_READ) {
					if (!$message->updateStatus(SQ_MSG_UNREAD)) {
						trigger_error('Status of message '.$data['msgid'].' was not updated', E_USER_WARNING);
					}
				}

				// delete messages
				if (in_array($data['msgid'], $delete) && $data['status'] != SQ_MSG_DELETED) {
					if (!$message->updateStatus(SQ_MSG_DELETED)) {
						trigger_error('Message '.$data['msgid'].' was not deleted', E_USER_WARNING);
					}
				}
			}
		}

		$o->addOnLoad('if (parent.frames["sidenav"] && parent.frames["sidenav"].refresh_internal_messages) parent.frames["sidenav"].refresh_internal_messages();');

		return true;

	}//end processMail()


	/**
	* Prints the trash interface
	*
	* @param object File				&$asset	the file asset
	* @param object Backend_Outputter	&$o		the backend outputter
	* @param string						$prefix	prefix for form elements
	*
	* @return boolean
	* @access public
	*/
	function paintTrash(&$asset, &$o, $prefix)
	{
		$user = &$asset->_getUser();

		$ms = &$GLOBALS['SQ_SYSTEM']->getMessagingService();
		$messages = $ms->getMessages($user->id, null, Array(SQ_MSG_DELETED), Array(), null, null, 'name');
		$write_access = $asset->writeAccess('mail');

		if (empty($messages)) {
			echo 'Your trash is empty';
		} else {
			?>
			<script type="text/javascript" language="Javascript">
				function showMessageBody(messageid) {
					var iframe = document.getElementById('sq_message_body');
					if (iframe == null) return;
					
					var url='<?php echo $_SERVER['PHP_SELF']; ?>' + '?a=<?php echo $asset->id; ?>&msgid=' + messageid;
					iframe.src = url;
				}
			</script>

			<table border="0" cellspacing="0" cellpadding="1" width="100%">
			<tr>
				<td colspan="<?php echo ($write_access) ? '5' : '3';?>" background="<?php echo sq_web_path('lib'); ?>/web/images/section_dots.gif" style="height:1px; padding:0px; margin:0px;"><img src="<?php echo sq_web_path('lib'); ?>/web/images/blank.gif" width="1" height="1" /></td>
			</tr>
			<tr>
				<td class="sq-backend-table-header">FROM</td>
				<td class="sq-backend-table-header">SUBJECT</td>
				<td class="sq-backend-table-header">SENT</td>
				<?php
				if ($write_access) {
					?>
					<td class="sq-backend-table-header">
						<?php check_box($prefix.'_select_all_recover', '1', false, "check_all(document.main_form, '{$prefix}_recover', this.checked);"); ?>
						RECOVER
					</td>
					<td class="sq-backend-table-header">
						<?php check_box($prefix.'_select_all_purge', '1', false, "check_all(document.main_form, '{$prefix}_purge', this.checked);"); ?>
						PURGE
					</td>
					<?php
				}
				?>
			</tr>
			<?php
			$alt = false;
			$num_printed = 0;
			$num_per_page = 10;
			$num_messages = count($messages);
			$start_printing_at = 0;
			if (isset($_REQUEST['sq_internal_message_trash_start'])) $start_printing_at = (int) $_REQUEST['sq_internal_message_trash_start'];

			for ($i = 0; $i < $num_messages; $i++) {
				if ($i < $start_printing_at) {
					$i++;
					continue;
				}

				$data = $messages[$i];

				if ($alt) $alt = false;
				else $alt = true;
				$class = 'sq-backend-table-cell'.(($alt) ? '-alt' : '');

				// work out the time of day icon
				if (date('A',$data['sent']) == 'AM') $time_img = sq_web_path('lib').'/web/images/icons/internal_message/clock_day.png';
				else $time_img = sq_web_path('lib').'/web/images/icons/internal_message/clock_night.png';
				
				// work out the sender icon
				$sender_img = $GLOBALS['SQ_SYSTEM']->am->getAssetIconURL($data['type_code']);

				?>
				<tr>
					<td class="<?php echo $class ?>" nowrap>
						<script language="JavaScript" type="text/javascript">sq_print_icon("<?php echo sq_web_path('lib'); ?>/web/images/icons/internal_message/priority_<?php echo $data['priority'];?>.png", "16", "16", "");</script>
						<script language="JavaScript" type="text/javascript">sq_print_icon("<?php echo $sender_img; ?>", "16", "16", "");</script>
						<a name="msg_<?php echo $data['msgid'];?>"></a>
						&nbsp;<?php echo $data['from_name'];?>
						<?php hidden_field($prefix.'_messages['.$data['msgid'].']', '1'); ?>
					</td>
					<td class="<?php echo $class ?>">
						<script language="JavaScript" type="text/javascript">sq_print_icon("<?php echo sq_web_path('lib'); ?>/web/images/icons/internal_message/message_subject.png", "16", "16", "");</script>
						&nbsp;<a class="sq-backend-table-cell" href="#" onClick="Javascript: showMessageBody('<?php echo $data['msgid'];?>'); return false;" style="text-decoration: none;"><?php echo $data['subject'];?></a>
					</td>
					<td class="<?php echo $class ?>" style="white-space: nowrap;">
						<script language="JavaScript" type="text/javascript">sq_print_icon("<?php echo $time_img; ?>", "16", "16", "");</script>
						&nbsp;<?php echo $GLOBALS['SQ_SYSTEM']->datetime($data['sent']); ?>
					</td>
					
					<?php
					if ($write_access) {
						?>
						<td class="<?php echo $class ?>" nowrap>
							<?php
							if ($asset->writeAccess('mail')) check_box($prefix.'_recover['.$data['msgid'].']');
							else echo '&nbsp;';
							?>
						</td>
						<td class="<?php echo $class ?>" nowrap>
							<?php check_box($prefix.'_purge['.$data['msgid'].']'); ?>
						</td>
						<?php
					}
					?>
				</tr>
				<tr>
					<td colspan="<?php echo ($write_access) ? '5' : '3';?>"><img src="<?php echo sq_web_path('lib'); ?>/web/images/blank.gif" width="1" height="1" /></td>
				</tr>
				<tr>
					<td colspan="<?php echo ($write_access) ? '5' : '3';?>" background="<?php echo sq_web_path('lib'); ?>/web/images/section_dots.gif" style="height:1px; padding:0px; margin:0px;"><img src="<?php echo sq_web_path('lib'); ?>/web/images/blank.gif" width="1" height="1" /></td>
				</tr>
				<tr>
					<td colspan="<?php echo ($write_access) ? '5' : '3';?>"><img src="<?php echo sq_web_path('lib'); ?>/web/images/blank.gif" width="1" height="1" /></td>
				</tr>
				<?php
				$num_printed++;
				if ($num_printed >= $num_per_page) break;
			}
			?>
				<tr>
					<td colspan="<?php echo ($write_access) ? '5' : '3';?>" align="center" class="sq-backend-table-cell">
					<?php
					hidden_field('sq_internal_message_trash_start', $start_printing_at);
					if ($start_printing_at > 0) {
						?><a style="text-decoration: none;" href="#" onClick="Javascript: set_hidden_field('sq_internal_message_trash_start', '<?php echo $start_printing_at - $num_per_page; ?>'); set_hidden_field('process_form', '0'); submit_form(); return false;"><?php
					} else {
						?><span style="color: #BBBBBB"><?php
					}
					?>
					<< Previous Page
					<?php
					if ($start_printing_at > 0) {
						?></a><?php
					} else {
						?></span><?php
					}
					?>
					&nbsp;<b>Page <?php echo round(($start_printing_at + $num_per_page) / $num_per_page); ?> of <?php echo round(($num_messages / $num_per_page) + 0.5); ?></b>&nbsp;
					
					<?php
					if (($start_printing_at + $num_per_page) < $num_messages) {
						?><a style="text-decoration: none;" href="#" onClick="Javascript: set_hidden_field('sq_internal_message_trash_start', '<?php echo $start_printing_at + $num_per_page; ?>'); set_hidden_field('process_form', '0'); submit_form(); return false;"><?php
					} else {
						?><span style="color: #BBBBBB"><?php
					}
					?>
					Next Page >>
					<?php
					if (($start_printing_at + $num_per_page) < $num_messages) {
						?></a><?php
					} else {
						?></span><?php
					}
					?>
					</td>
				</tr>
			</table>
			<p>
			<iframe src="" id="sq_message_body" width="100%" height="300" frameborder="1"></iframe>
			<?php
		}
		return true;

	}//end paintTrash()


	/**
	* Processes the trash interface
	*
	* @param object Asset				$asset	the asset to which we belong
	* @param object	Backend_Outputter	$o		the outputter class
	* @param string						$prefix	prefix for the form element
	*
	* @return boolean
	* @access public
	*/
	function processTrash(&$asset, &$o, $prefix)
	{
		$msgs    = (isset($_POST[$prefix.'_messages'])) ? array_keys($_POST[$prefix.'_messages']) : Array();
		$recover = (isset($_POST[$prefix.'_recover'])) ? array_keys($_POST[$prefix.'_recover']) : Array();
		$purge   = (isset($_POST[$prefix.'_purge'])) ? array_keys($_POST[$prefix.'_purge']) : Array();

		$user = &$asset->_getUser();

		$ms = &$GLOBALS['SQ_SYSTEM']->getMessagingService();
		$messages = $ms->getMessages($user->id);

		if (!empty($recover)) {
			foreach ($recover as $messageid) {
				// recover messages to inbox
				$message = $ms->getMessageById($messageid);
				if (!$message->updateStatus(SQ_MSG_READ)) {
					trigger_error('Message '.$messageid.' was not recovered', E_USER_WARNING);
				}
			}
		}

		if (!empty($purge)) {
			foreach ($purge as $messageid) {
				// delete messsage FOREVER
				$message = $ms->getMessageById($messageid);
				if (!$message->delete()) {
					trigger_error('Message '.$messageid.' was not deleted', E_USER_WARNING);
				}
			}
		}

		return true;

	}//end processTrash()

}//end class

?>
